{"title":"Produire des repr√©sentations graphiques avec {{< fa brands r-project >}} et `ggplot2`","markdown":{"yaml":{"title":"Produire des repr√©sentations graphiques avec {{< fa brands r-project >}} et `ggplot2`","echo":true,"number-sections":true},"headingText":"Donn√©es","containsRefs":false,"markdown":"\n\n::: {.badge}\n<a href=\"https://datalab.sspcloud.fr/launcher/ide/rstudio?autoLaunch=false&networking.user.enabled=true&onyxia.friendlyName=%C2%ABrstudio-cours-ENS%C2%BB\" target=\"_blank\" rel=\"noopener\"><img src=\"https://img.shields.io/badge/Tester%20via%20SSP%20cloud%20-%20SSPCloud?logo=R&labelColor=black&color=%231965b8\" alt=\"Onyxia\"></a><br>\n:::\n\n<details>\n<summary>\nD√©rouler les _slides_ ci-dessous ou [cliquer ici](/slides/ggplot.qmd)\npour afficher les slides en plein √©cran.\n</summary>\n\n\n``` {.yaml code-preview=\"/slides/ggplot.qmd\"}\n```\n\n</details>\n\n\nDans ce troisi√®me TP,\nnous allons apprendre √† cr√©er des repr√©sentations\ngraphiques synth√©tiques avec {{< fa brands r-project >}} qui est\ntr√®s bien outill√© dans le domaine gr√¢ce √† la librairie\n`ggplot2`. Cette derni√®re impl√©mente\nune [grammaire des graphiques](https://fr.wikibooks.org/wiki/Programmer_en_R/Comprendre_la_grammaire_des_graphiques)\nflexible, coh√©rente et simple d'usage. \n\nSi vous √™tes int√©ress√©s par `Python` {{< fa brands python >}},\nune version tr√®s proche de ce TP est disponible dans [mon cours de l'ENSAE](https://pythonds.linogaliana.fr/content/visualisation/matplotlib.html).\n\n\n::: {.callout-note}\n\nCertains exemples de code pr√©sentent des annotations sur le c√¥t√©,\npassez votre souris dessus pour les afficher, comme ci-dessous\n\n```{r}\n#| echo: true\n#| output: false\n\"une annotation explicative m'accompagne √† droite\" #<1>\n```\n1. Je m'affiche quand on passe la souris sur moi üê≠ !\n\n:::\n\nLa pratique de la visualisation se fera, dans ce cours, en r√©pliquant des graphiques qu'on peut trouver sur\nla page de l'*open data* de la ville de Paris \n[ici](https://opendata.paris.fr/explore/dataset/comptage-velo-donnees-compteurs/dataviz/?disjunctive.id_compteur&disjunctive.nom_compteur&disjunctive.id&disjunctive.name).\n\n\nCe TP vise √† initier:\n\n* Principalement au _package_ [`ggplot2`](https://ggplot2.tidyverse.org/) pour la construction de graphiques fig√©s ;\n* Au package [`plotly`](https://plotly.com/r/) pour les graphiques \ndynamiques, au format HTML. Nous approfondirons l'apprentissage des\ngraphiques HTML dans un prochain chapitre en\nd√©couvrant [`Observable`](https://observablehq.com/).\n\nDans ce chapitre, nous allons utiliser les librairies suivantes:\n\n```{r}\n#| echo: true\n#| output: false\nlibrary(scales)\nlibrary(readr)\nlibrary(dplyr)\nlibrary(forcats)\nlibrary(lubridate)\nlibrary(ggplot2)\nlibrary(plotly)\n```\n\nNous verrons par la suite la mani√®re de construire des cartes facilement avec\ndes formats √©quivalents.\n\n::: {.callout-note}\n√ätre capable de construire des visualisations de donn√©es\nint√©ressantes est une comp√©tence n√©cessaire √† tout\n_data-scientist_ ou chercheur. Pour am√©liorer\nla qualit√© de ces visualisations, il est recommand√©\nde suivre certains conseils donn√©s par des sp√©cialistes\nde la _dataviz_ sur la s√©miologie graphique.\n\nLes bonnes visualisations de donn√©es, comme celles du _New York Times_,\nreposent certes sur des outils adapt√©s (des librairies `JavaScript`)\nmais aussi sur certaines r√®gles de repr√©sentation qui permettent\nde comprendre en quelques secondes le message d'une visualisation.\n\nCe [post de blog](https://blog.datawrapper.de/text-in-data-visualizations/)\nest une ressource qu'il est utile de consulter r√©guli√®rement. \nCe [post de blog d'Albert Rapp](https://albert-rapp.de/posts/ggplot2-tips/10_recreating_swd_look/10_recreating_swd_look) montre bien comment construire graduellement une bonne visualisation\nde donn√©es. \n:::\n\n\n\nUn sous-ensemble des donn√©es de [Paris _Open Data_](https://opendata.paris.fr/explore/dataset/comptage-velo-donnees-compteurs/information/?disjunctive.id_compteur&disjunctive.nom_compteur&disjunctive.id&disjunctive.name) a √©t√© mis √† disposition\npour faciliter l'import. \nIl s'agit d'une extraction, qui commence √† dater, des donn√©es disponibles\nsur le site o√π seules les colonnes\nqui servent √† cet exercice ont √©t√© conserv√©es.\n\nNous proposons\nde t√©l√©charger ces donn√©es et les enregistrer dans un fichier sur le disque\ndur local avant de l'importer[^1]. Cependant, nous n'allons pas faire\ncela manuellement mais nous allons plut√¥t utiliser \n{{< fa brands r-project >}}. Effectuer ce type d'action de mani√®re\nmanuelle serait une mauvaise pratique du point de vue de la reproductibilit√©.\n\n```{r}\n#| echo: true\nurl <- \"https://minio.lab.sspcloud.fr/projet-formation/diffusion/python-datascientist/bike.csv\"\ndownload.file(url, \"bike.gz\") # <1>\n```\n1. L'extension `.gz` est importante pour la suite car `readr` en a besoin pour comprendre que le fichier est compress√©.\n\n## Premi√®res productions graphiques\n\nChercher √† produire une visualisation parfaite du premier coup est\nillusoire. Il est beaucoup plus r√©aliste d'am√©liorer graduellement \nune repr√©sentation graphique afin, petit √† petit, de mettre en \navant les effets de structure dans un jeu de donn√©es. \n\nNous allons donc commencer par nous repr√©senter la distribution\ndes passages aux principales stations de mesure.\nPour cela nous allons produire\nrapidement un _barplot_ puis l'am√©liorer graduellement. \n\n\nDans cette partie, nous allons ainsi\nreproduire les deux premiers graphiques de la\n[page d'analyse des donn√©es](https://opendata.paris.fr/explore/dataset/comptage-velo-donnees-compteurs/dataviz/?disjunctive.id_compteur&disjunctive.nom_compteur&disjunctive.id&disjunctive.name):\n*Les 10 compteurs avec la moyenne horaire la plus √©lev√©e* et *Les 10 compteurs ayant comptabilis√©s le plus de v√©los*. Les valeurs chiffr√©es des graphiques seront diff√©rentes de celles de la page en ligne, c'est normal, nous travaillons sur des donn√©es plus anciennes. \n\n\n[^1]: D'habitude, nous recommandons d'utiliser directement l'URL \nde t√©l√©chargement ce qui √©vite de cr√©er un fichier interm√©diaire\nsur le disque dur. N√©anmoins, ici, l'import direct avec `readr`\nne fonctionnera pas car le fichier est mal interpr√©t√© par la\nlibrairie. Celle-ci ne comprend pas que le fichier est compress√© car\nil lui manque l'extension `.gz` (un format compress√©) √† la fin. \n\n\n\n::: {.callout-tip}\n## Exercice 1 : Importer les donn√©es et produire un premier graphique rapidement\n\nLes donn√©es comportent plusieurs dimensions pouvant faire l'objet d'une \nanalyse statistique. Il est donc n√©cessaire dans un premier temps\nde synth√©tiser celles-ci par des agr√©gations afin d'avoir un\ngraphique lisible. \n\n1. Importer les donn√©es de compteurs de v√©los depuis le fichier `bike.gz` ;\n2. Garder les dix bornes √† la moyenne la plus √©lev√©e ;\n\n```{r}\n#| output: false\ndf <- readr::read_csv(\"bike.gz\")\n```\n\n\n```{r}\ndf1 <- df %>%\n  group_by(`Nom du compteur`) %>%\n  summarise(`Comptage horaire` = mean(`Comptage horaire`, na.rm = TRUE)) %>%\n  arrange(desc(`Comptage horaire`)) %>%\n  head(10)\n```\n\n<details>\n<summary>\nLes 10 principales stations √† l'issue de la question 2\n</summary>\n```{r}\nhead(df1)\n```\n</details>\n\nOn va maintenant pouvoir se concentrer sur la production de la \nrepr√©sentation\n\n3. En premier lieu, sans se pr√©occuper des √©l√©ments de style ni de la beaut√©\ndu graphique, cr√©er la structure du _barplot_ (diagramme en batons) de la\n[page d'analyse des donn√©es](https://opendata.paris.fr/explore/dataset/comptage-velo-donnees-compteurs/dataviz/?disjunctive.id_compteur&disjunctive.nom_compteur&disjunctive.id&disjunctive.name):\n\n<details>\n<summary>\nFigure obtenue, sans s'occuper du style\n</summary>\n```{r}\nggplot(df1, aes(y = `Nom du compteur`, x = `Comptage horaire`)) +\n  geom_bar(stat = \"identity\")\n```\n</details>\n\nLa suite de l'exercice consiste √† am√©liorer graduellement cette repr√©sentation\npour converger vers la reproduction de la version en _open data_. Il\nne s'agit pas encore de se concentrer sur l'esth√©tique de la figure mais\nde la rendre intelligible, √† gros trait. \n\n4. En premier lieu, r√©ordonner les barres sur l'axe des ordonn√©es\ngr√¢ce √† la fonction `reorder`. Cela rendra le message de la figure\nplus intelligible. \n\n<details>\n<summary>\nFigure avec les barres r√©ordonn√©es\n</summary>\n\n```{r}\nfigure1 <- ggplot(df1,\n       aes(y = reorder(`Nom du compteur`, `Comptage horaire`), # <1>\n           x = `Comptage horaire`)\n       ) +\n  geom_bar(stat = \"identity\")\nfigure1\n```\n1. On r√©ordonne `Nom du compteur` en fonction de `Comptage horaire`\n\n</details>\n\n\n5. Modifier votre couche esth√©tique afin\nd'appliquer une couleur rouge √† l'ensemble des barres\n\n<details>\n<summary>\nFigure avec les barres rouges\n</summary>\n\n```{r}\nfigure1 <- ggplot(df1,\n       aes(y = reorder(`Nom du compteur`, `Comptage horaire`), # <1>\n           x = `Comptage horaire`)\n       ) +\n  geom_bar(stat = \"identity\", fill = \"red\")\nfigure1\n```\n\n</details>\n\n:::\n\nOn commence √† avoir quelque chose qui commence √† transmettre\nun message synth√©tique sur la nature des donn√©es.\nOn peut n√©anmoins remarquer plusieurs √©l√©ments probl√©matiques\n(par exemple les labels) mais\naussi des √©l√©ments ne correspondant pas (les titres des axes, etc.) ou \nmanquants (le nom du graphique...)\n\n\n::: {.callout-tip}\n## Exercice 2 : Un peu de style !\n\nLa figure comporte maintenant un message mais il est encore peu\nlisible. \n\n1. Le minimum pour que quelqu'un ne connaissant pas les donn√©es soit\ncapable de comprendre la repr√©sentation graphique est de labelliser\nles axes. Cr√©er les m√™mes labels d'axes que la figure originale. \n\n<details>\n<summary>\nFigure avec les axes nomm√©s\n</summary>\n\n```{r}\nfigure1 <- figure1 + labs( # <1>\n  title = \"Les 10 compteurs avec la moyenne horaire la plus √©lev√©e\",\n  x = \"Nom du compteur\",\n  y = \"Moyenne horaire\"\n)\nfigure1\n```\n1. Il existe de nombreuses mani√®res de proc√©der avec `ggplot` pour labelliser\nles axes. Mais la plus simple est la fonction `labs`\n\n</details>\n\n\n2. Le fond gris permet est certes une marque distinctive que le graphique a √©t√©\nproduit avec `ggplot2` mais ce n'est pas tr√®s soign√©.\nUtiliser un th√®me plus minimaliste afin d'avoir un fond blanc.\n\n<details>\n<summary>\nFigure avec un fond blanc\n</summary>\n```{r}\nfigure1 <- figure1 +\n  theme_minimal()\nfigure1\n```\n\n</details>\n\n3. Maintenant, concentrons nous sur les √©l√©ments plus esth√©tiques.\nComme c'est une fonctionnalit√© un peu plus avanc√©e, nous proposons directement\nle code pour mettre √† jour votre figure avec les √©l√©ments de style\nsuivant:\n\n```r\ntheme(\n  axis.text.x = element_text(angle = 45, hjust = 1, color = \"red\"),\n  axis.title.x = element_text(color = \"red\"),\n  plot.title = element_text(hjust = 0.5),\n  plot.margin = margin(1, 4, 1, 1, \"cm\")\n)\n```\n\n<details>\n<summary>\nFigure obtenue √† l'issue de ces questions\n</summary>\n```{r}\nfigure1 <- figure1 +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1, color = \"red\"),\n    axis.title.x = element_text(color = \"red\"),\n    plot.title = element_text(hjust = 0.5),\n    plot.margin = margin(1, 4, 1, 1, \"cm\")\n    )\nfigure1\n```\n\n4. Enfin ajoutons de la complexit√© au graphique avec les chiffres sur\nles barres.\nEn vous aidant de ce [_post_](https://stackoverflow.com/questions/67767859/adding-text-on-each-bar-in-horizontal-bar-plot-in-ggplot), ajouter les comptages horaires moyens comme sur la\nfigure de l'_open data_ parisien[^annotation]\n\n```{r}\nfigure1 <- figure1 + \n  geom_text(\n    aes(label=round(`Comptage horaire`)),\n    position=position_dodge(width=0.9),\n    hjust=-0.5\n    )\n```\n\n[^annotation]: Ce n'est pas forc√©ment une bonne pratique de _dataviz_ de\nfaire cela. En effet, cela signifie que l'√©chelle et la diversit√©\ndes donn√©es dans celle-ci ne sont pas directement \nintelligibles. \n\n</details>\n\n:::\n\nOn comprend\nainsi que le boulevard de S√©bastopol est le plus emprunt√©,\nce qui ne vous suprendra pas si vous faites du v√©lo √† Paris. \nN√©anmoins, si vous n'√™tes pas familiers avec la g√©ographie parisienne,\ncela sera peu informatif pour vous, vous allez avoir besoin d'une\nrepr√©sentation graphique suppl√©mentaire: une carte ! Nous verrons\nceci lors d'un prochain chapitre. \n\n```{r}\n#| fig-cap: \"Les 10 compteurs avec la moyenne horaire la plus √©lev√©e\"\nfigure1\n```\n\n::: {.callout-tip}\n## Exercice 3: produire une nouvelle figure\n\nFaire la m√™me chose pour la figure 2 (_\"Les 10 compteurs ayant comptabilis√©s le plus de v√©los\"_), afin d'obtenir une figure similaire.\n\n<details>\n\n```{r}\ndf2 <- df %>%\n  group_by(`Nom du compteur`) %>%\n  summarise(`Comptage horaire` = sum(`Comptage horaire`, na.rm = TRUE)) %>%\n  arrange(desc(`Comptage horaire`)) %>%\n  head(10)\n```\n\n```{r}\n# Create a horizontal bar plot\nfigure2 <- ggplot(df2, aes(y = reorder(`Nom du compteur`, `Comptage horaire`), x = `Comptage horaire`)) +\n  geom_bar(stat = \"identity\", fill = \"forestgreen\") +\n  labs(title = \"Les 10 compteurs ayant comptabilis√©s le plus de v√©los\",\n       x = \"Nom du compteur\",\n       y = \"La somme des v√©los comptabilis√©s sur la p√©riode s√©lectionn√©e\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        axis.title.x = element_text(color = \"forestgreen\"),\n        plot.title = element_text(hjust = 0.5),\n        plot.margin = margin(1, 4, 1, 1, \"cm\"))\n```\n\n<summary>\nFigure 2 √† l'issue de cet exercice\n</summary>\n\n```{r}\nfigure2\n```\n\n</details>\n\n\n\n:::\n\n\nLes diagrammes en batons (_barplot_) sont extr√™mement communs mais \nqu'ils transmettent. Sur le plan s√©miologique,\nles _lollipop charts_ sont pr√©f√©rables: ils\ntransmettent la m√™me information mais avec moins de bruit\n(la largeur des barres du barplot noie un peu l'information).\n\nVoici, par exemple, la deuxi√®me figure de la page, rendue non plus\nsous forme de _barplot_ mais sous forme de _lollipop chart_:\n\n\n```{r}\ndf2_lollipop <- df2 %>%\n  mutate(x =  fct_reorder(`Nom du compteur`, `Comptage horaire` ), y = `Comptage horaire`)\n\nfigure2_lollipop <- ggplot(df2_lollipop, aes(x=x, y=y)) +\n    geom_segment( aes(xend=x, yend=0), alpha = 0.4) +\n    geom_point( size=5, color=\"forestgreen\") +\n    coord_flip() +\n  labs(title = \"Les 10 compteurs ayant comptabilis√©s le plus de v√©los\",\n       x = \"Nom du compteur\",\n       y = \"La somme des v√©los comptabilis√©s sur la p√©riode s√©lectionn√©e\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        axis.title.x = element_text(color = \"forestgreen\"),\n        plot.title = element_text(hjust = 0.5),\n        plot.margin = margin(1, 4, 1, 1, \"cm\")) +\n  scale_y_continuous(labels = unit_format(unit = \"M\", scale=1e-6))\n```\n\n```{r}\nfigure2_lollipop\n```\n\n<details>\n<summary>\nComparaison du _barplot_ et du _lollipop chart_\n</summary>\n```{r}\n#| layout-ncol: 2\n#| fig-cap: \"Choisissez votre repr√©sentation pr√©f√©r√©e\"\n#| fig-subcap: \n#|   - \"Barplot\"\n#|   - \"Lollipop\"\nfigure2\nfigure2_lollipop\n```\n</details>\n\n\n::: {.callout-tip}\n## Exercice 3 bis (optionnel): produire un _lollipop_ chart\n\nReprendre l'exercice 2 mais √† la place d'un _barplot_, produire\nun _lollipop chart_.  \n::: \n\n## Premi√®re agr√©gation temporelle\n\nOn va maintenant se concentrer sur la dimension spatiale de notre\njeu de donn√©es √† travers deux approches:\n\n- Un diagramme en barre synth√©tisant l'information de notre jeu de donn√©es\nde mani√®re mensuelle ;\n- Des s√©ries instructives sur la dynamique temporelle. Cela sera l'objet de la prochaine partie ;\n\n\nPour commencer, reproduisons la troisi√®me figure qui est, encore une fois, \nun _barplot_. La premi√®re question implique une premi√®re rencontre avec\nune donn√©e temporelle √† travers une op√©ration assez classique en s√©ries\ntemporelles: changer le format d'une date pour pouvoir faire une agr√©gation\n√† un pas de temps plus large. \n\n::: {.callout-tip}\n## Exercice 4: barplot des comptages mensuels\n\n1. Utiliser la fonction `format` pour cr√©er une variable `month`\ndont le format respecte, par exemple, le sch√©ma `2019-08` ;\n2. Faire la moyenne des comptages horaires pour chaque mois\n\n```{r}\ndf <- df %>%\n  mutate(month = format(`Date et heure de comptage`, \"%Y-%m\"))\n```\n\n```{r}\n# Question 2\ncomptage_horaires_mois <- df %>%\n  group_by(month) %>%\n  summarise(value = mean(`Comptage horaire`, na.rm = TRUE))\n```\n\n<details>\n<summary>\nComptages horaires obtenus √† l'issue de cette question\n</summary>\n\n```{r}\ncomptage_horaires_mois\n```\n\n</details>\n\nAppliquer les conseils pr√©c√©dents pour construire et am√©liorer\ngraduellement un graphique afin d'obtenir une figure similaire\n√† la 3e production sur la page de l'_open data_ parisien.\n\n```{r}\nfigure3 <- ggplot(comptage_horaires_mois) +\n  geom_bar(aes(x = month, y = value), fill = \"#ffcd00\", stat = \"identity\") +\n  labs(x = \"Date et heure de comptage\", y = \"Moyenne mensuelle du comptage par heure\\nsur la p√©riode s√©lectionn√©e\",\n       title = \"Moyenne mensuelle des comptages v√©los\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        axis.title.y = element_text(color = \"#ffcd00\", face = \"bold\"),\n        plot.title = element_text(hjust = 0.5),\n        plot.margin = margin(1, 4, 1, 1, \"cm\"))\n```\n\n<details>\n<summary>\nExemple de figure reproduisant l'_open data_ parisien\n</summary>\n\n```{r}\nfigure3\n```\n\n</details>\n\n- Question optionnelle: repr√©senter la m√™me information sous forme de _lollipop_\n\n:::\n\n\n```{r}\nfigure3\n```\n\nSi vous pr√©f√©rez repr√©senter cela sous forme de _lollipop_[^notecouleur]:\n\n```{r}\nggplot(comptage_horaires_mois, aes(x = month, y = value)) +\n  geom_segment(aes(xend = month, yend = 0)) +\n  geom_point( color=\"#ffcd00\", size=4) +\n  labs(x = \"Date et heure de comptage\", y = \"Moyenne mensuelle du comptage par heure\\nsur la p√©riode s√©lectionn√©e\",\n       title = \"Moyenne mensuelle des comptages v√©los\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        #axis.title.y = element_text(color = \"#ffcd00\", face = \"bold\"),\n        plot.title = element_text(hjust = 0.5),\n        plot.margin = margin(1, 4, 1, 1, \"cm\"))\n```\n\n[^notecouleur]: J'ai retir√© la couleur sur l'axe des ordonn√©es qui, je trouve,\napporte peu √† la figure voire d√©grade la compr√©hension du message. \n\n\n## Premi√®re s√©rie temporelle\n\nIl est plus commun de repr√©senter sous forme de s√©rie\nles donn√©es ayant une dimension temporelle.\n\n\n::: {.callout-tip}\n## Exercice 5: Repr√©senter une s√©rie temporelle\n\n1. Cr√©er une variable `day` qui transforme l'horodatage en format journalier\ndu type `2021-05-01`.\n\n```{r}\ndf <- df %>%\n  mutate(day = date(`Date et heure de comptage`))\n\nmoyenne_quotidienne <- df %>%\n  group_by(day) %>%\n  summarise(value = mean(`Comptage horaire`, na.rm = TRUE))\n```\n\n2. Repr√©senter sous forme de s√©rie temporelle cette information, sans vous\npr√©occuper du style de la figure.\n\n```{r}\nfigure4 <- ggplot(moyenne_quotidienne, aes(x = day, y = value)) +\n  geom_line(color = \"magenta\")\n```\n\n<details>\n<summary>\nFigure minimaliste\n</summary>\n```{r}\nfigure4\n```\n</details>\n\n3. Colorer la zone sous la ligne avec la fonction appropri√©e\n\n```{r}\nfigure4 <- figure4 +\n  geom_area(fill=\"magenta\", alpha = 0.6)\n```\n\n<details>\n<summary>\nFigure avec la coloration sous la ligne\n</summary>\n```{r}\nfigure4\n```\n</details>\n\n4. Finaliser le graphique pour reproduire la figure de la page d'_open data_\n\n```{r}\nfigure4 <- figure4 +\n  labs(x = \"Date et heure de comptage (Jour)\", y = \"Moyenne journali√®re du comptage par heure\\nsur la p√©riode s√©lectionn√©e\",\n       title = \"Moyenne journali√®re des comptages v√©los\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        plot.title = element_text(hjust = 0.5),\n        plot.margin = margin(1, 4, 1, 1, \"cm\"))\n```\n\n<details>\n<summary>\nFigure finalis√©e\n</summary>\n```{r}\nfigure4\n```\n</details>\n\nVoici quelques aides pour cet exercice\n\n\n<details>\n<summary>\nüí° Aide pour la question 1\n</summary>\nRegardez la fonction `day` du _package_ `lubridate`\n</details>\n\n<details>\n<summary>\nüí° Aide pour la question 3\n</summary>\n[Ce _thread_ sur `stackoverflow`](https://stackoverflow.com/questions/28730083/filling-in-the-area-under-a-line-graph-in-ggplot2-geom-area) peut vous aider.\n</details>\n\n\n<details>\n<summary>\nLe jeu de donn√©es pour la figure 4\n</summary>\n```{r}\nhead(moyenne_quotidienne)\n```\n</details>\n\n:::\n\nA l'issue de cet exercice, on obtient ainsi une figure prenant la forme\nsuivante:\n\n```{r}\nfigure4\n```\n\n\n## Introduction aux graphiques HTML avec `Plotly`\n\nL'inconv√©nient des figures avec `ggplot` est que celles-ci ne permettent\npas d'interaction avec le lecteur. Toute l'information doit donc √™tre\ncontenue dans la figure ce qui peut la rendre difficile √† lire. \nSi la figure est bien faite, avec diff√©rents niveaux d'information, cela\npeut bien fonctionner.\n\nIl est n√©anmoins plus simple, gr√¢ce aux technologies _web_, de proposer des\nvisualisations √† plusieurs niveaux. Un premier niveau d'information, celui du\ncoup d'oeil, peut suffire √† assimiler les principaux messages de la\nvisualisation. Ensuite, un comportement plus volontaire de recherche\nd'information secondaire peut permettre d'en savoir plus. Les visualisations\nr√©actives, qui sont maintenant la norme dans le monde de la _dataviz_, \npermettent ce type d'approche: le lecteur d'une visualisation peut passer\nsa souris √† la recherche d'information compl√©mentaire (par exemple les\nvaleurs exactes) ou cliquer pour faire appara√Ætre des informations compl√©mentaires\nsur la visualisation ou autour.\n\nCes visualisations reposent sur le m√™me triptyque que l'ensemble de l'√©cosyst√®me\n_web_: `HTML`, `CSS` et `JavaScript`. Les utilisateurs de {{< fa brands r-project >}} \nne vont jamais manipuler directement ces langages, qui demandent une \ncertaine expertise, mais vont utiliser des librairies au niveau de {{< fa brands r-project >}} qui g√©n√®reront automatiquement tout le code `HTML`, `CSS` et `JavaScript`\npermettant de cr√©er la figure. \n\n::: {.callout-tip}\n## Exercice 6: s√©rie temporelle interactive\n\n1. Cr√©er une figure `Plotly` basique pour repr√©senter\nsous forme de s√©rie temporelle la figure 4, sans se pr√©occuper du style\n\n<details>\n<summary>\nS√©rie temporelle produite sans √©l√©ment de style\n</summary>\n```{r}\nplot_ly(\n  moyenne_quotidienne, x = ~day, y = ~value,\n  type = 'scatter', mode = 'lines'\n)\n```\n</details>\n\n\n2. A partir de l'exemple dans la [documentation](https://plotly.com/r/filled-area-plots/),\najouter une aire sous la figure\n\n<details>\n<summary>\nAjout de la couche sous la ligne\n</summary>\n\n```{r}\nplot_ly(\n  moyenne_quotidienne, x = ~day, y = ~value,\n  fill = 'tozeroy',\n  type = 'scatter', mode = 'lines'\n)\n```\n</details>\n\n\n3. Jouer sur les √©l√©ments de style pour reproduire la figure 4. Pour profiter\nde la r√©activit√© du graphique, soigner l'information obtenue en passant\nla souris sur la figure gr√¢ce aux arguments `hovertemplate` et `hoverinfo`\n\n```{r}\nfig <- plot_ly(\n  moyenne_quotidienne, x = ~day, y = ~value,\n  color = I(\"magenta\"),\n  hovertemplate = ~paste(day, \": \", round(value), \" passages de v√©lo en moyenne par heure\"),\n  hoverinfo = \"text\",\n  fill = 'tozeroy',\n  type = 'scatter', mode = 'lines')\nfig4 <- fig %>%\n  layout(title = \"Moyenne journali√®re des comptages v√©los\",\n         xaxis = list(title = \"Date et heure de comptage (Jour)\"),\n         yaxis = list(title = \"Moyenne journali√®re du comptage par heure\\nsur la p√©riode s√©lectionn√©e\"))\n```\n\n\n<details>\n<summary>\nFigure obtenue\n</summary>\n\n```{r}\nfig4\n```\n\n</details>\n\n:::\n\n\nLa version r√©active de la figure est ainsi\n\n```{r}\nfig4\n```\n\n\nCette repr√©sentation montre bien le caract√®re sp√©cial de l'ann√©e 2020. Pour \nrappeller au lecteur distrait la nature particuli√®re de la p√©riode, marqu√©e\npar un premier confinement qu'on voit bien dans les donn√©es, on peut,\navec l'aide de la [documentation](https://plotly.com/r/horizontal-vertical-shapes/),\najouter deux barres verticales pour marquer les dates de d√©but et\nde fin de cette p√©riode:\n\n\n```{r}\n#| echo: true\nvline <- function(x = 0, color = \"royalblue\") {\n  list(\n    type = \"line\",\n    y0 = 0,\n    y1 = 1,\n    yref = \"paper\",\n    x0 = x,\n    x1 = x,\n    line = list(color = color, dash=\"dot\")\n  )\n}\n\nfig4 %>% layout(shapes = list(vline(\"2020-03-17\"), vline(\"2020-05-11\")))\n```\n\nComme dernier exercice, voici comment reproduire cette figure avec \n`Plotly`:\n\n```{r}\ndf1 <- df1 %>% mutate(`Nom du compteur` = fct_reorder(`Nom du compteur`, `Comptage horaire`))\n\nfig <- plot_ly(\n  df1,\n  x = ~ `Comptage horaire`, y = ~`Nom du compteur`,\n  color = I(\"red\"),\n  hovertext = ~paste0(`Nom du compteur`, \": \", round(`Comptage horaire`)),\n  hoverinfo = 'text',\n  type = 'bar',\n  name = 'Principales stations')\n\n\nfig <- fig %>% layout(\n  yaxis = list(title = 'Moyenne horaire'),\n  xaxis = list(title = 'Nom du compteur', color = \"red\")\n  )\n```\n\n\n```{r}\nfig\n```\n\n::: {.callout-tip}\n## Exercice 7: un barplot avec `Plotly`\n\n1. Pour avoir imm√©diatement des barres bien ordonn√©es, utiliser la fonction\n`fct_reorder` du package `forcats` pour r√©oordonner les valeurs du dataframe\nissu de l'exercice 1\n2. Utiliser `Plotly` pour cr√©er votre figure.\n3. (Optionnel, plus avanc√©) Faire un _lollipop chart_ avec `Plotly`\n:::\n\n","srcMarkdownNoYaml":"\n\n::: {.badge}\n<a href=\"https://datalab.sspcloud.fr/launcher/ide/rstudio?autoLaunch=false&networking.user.enabled=true&onyxia.friendlyName=%C2%ABrstudio-cours-ENS%C2%BB\" target=\"_blank\" rel=\"noopener\"><img src=\"https://img.shields.io/badge/Tester%20via%20SSP%20cloud%20-%20SSPCloud?logo=R&labelColor=black&color=%231965b8\" alt=\"Onyxia\"></a><br>\n:::\n\n<details>\n<summary>\nD√©rouler les _slides_ ci-dessous ou [cliquer ici](/slides/ggplot.qmd)\npour afficher les slides en plein √©cran.\n</summary>\n\n\n``` {.yaml code-preview=\"/slides/ggplot.qmd\"}\n```\n\n</details>\n\n\nDans ce troisi√®me TP,\nnous allons apprendre √† cr√©er des repr√©sentations\ngraphiques synth√©tiques avec {{< fa brands r-project >}} qui est\ntr√®s bien outill√© dans le domaine gr√¢ce √† la librairie\n`ggplot2`. Cette derni√®re impl√©mente\nune [grammaire des graphiques](https://fr.wikibooks.org/wiki/Programmer_en_R/Comprendre_la_grammaire_des_graphiques)\nflexible, coh√©rente et simple d'usage. \n\nSi vous √™tes int√©ress√©s par `Python` {{< fa brands python >}},\nune version tr√®s proche de ce TP est disponible dans [mon cours de l'ENSAE](https://pythonds.linogaliana.fr/content/visualisation/matplotlib.html).\n\n\n::: {.callout-note}\n\nCertains exemples de code pr√©sentent des annotations sur le c√¥t√©,\npassez votre souris dessus pour les afficher, comme ci-dessous\n\n```{r}\n#| echo: true\n#| output: false\n\"une annotation explicative m'accompagne √† droite\" #<1>\n```\n1. Je m'affiche quand on passe la souris sur moi üê≠ !\n\n:::\n\nLa pratique de la visualisation se fera, dans ce cours, en r√©pliquant des graphiques qu'on peut trouver sur\nla page de l'*open data* de la ville de Paris \n[ici](https://opendata.paris.fr/explore/dataset/comptage-velo-donnees-compteurs/dataviz/?disjunctive.id_compteur&disjunctive.nom_compteur&disjunctive.id&disjunctive.name).\n\n\nCe TP vise √† initier:\n\n* Principalement au _package_ [`ggplot2`](https://ggplot2.tidyverse.org/) pour la construction de graphiques fig√©s ;\n* Au package [`plotly`](https://plotly.com/r/) pour les graphiques \ndynamiques, au format HTML. Nous approfondirons l'apprentissage des\ngraphiques HTML dans un prochain chapitre en\nd√©couvrant [`Observable`](https://observablehq.com/).\n\nDans ce chapitre, nous allons utiliser les librairies suivantes:\n\n```{r}\n#| echo: true\n#| output: false\nlibrary(scales)\nlibrary(readr)\nlibrary(dplyr)\nlibrary(forcats)\nlibrary(lubridate)\nlibrary(ggplot2)\nlibrary(plotly)\n```\n\nNous verrons par la suite la mani√®re de construire des cartes facilement avec\ndes formats √©quivalents.\n\n::: {.callout-note}\n√ätre capable de construire des visualisations de donn√©es\nint√©ressantes est une comp√©tence n√©cessaire √† tout\n_data-scientist_ ou chercheur. Pour am√©liorer\nla qualit√© de ces visualisations, il est recommand√©\nde suivre certains conseils donn√©s par des sp√©cialistes\nde la _dataviz_ sur la s√©miologie graphique.\n\nLes bonnes visualisations de donn√©es, comme celles du _New York Times_,\nreposent certes sur des outils adapt√©s (des librairies `JavaScript`)\nmais aussi sur certaines r√®gles de repr√©sentation qui permettent\nde comprendre en quelques secondes le message d'une visualisation.\n\nCe [post de blog](https://blog.datawrapper.de/text-in-data-visualizations/)\nest une ressource qu'il est utile de consulter r√©guli√®rement. \nCe [post de blog d'Albert Rapp](https://albert-rapp.de/posts/ggplot2-tips/10_recreating_swd_look/10_recreating_swd_look) montre bien comment construire graduellement une bonne visualisation\nde donn√©es. \n:::\n\n\n## Donn√©es\n\nUn sous-ensemble des donn√©es de [Paris _Open Data_](https://opendata.paris.fr/explore/dataset/comptage-velo-donnees-compteurs/information/?disjunctive.id_compteur&disjunctive.nom_compteur&disjunctive.id&disjunctive.name) a √©t√© mis √† disposition\npour faciliter l'import. \nIl s'agit d'une extraction, qui commence √† dater, des donn√©es disponibles\nsur le site o√π seules les colonnes\nqui servent √† cet exercice ont √©t√© conserv√©es.\n\nNous proposons\nde t√©l√©charger ces donn√©es et les enregistrer dans un fichier sur le disque\ndur local avant de l'importer[^1]. Cependant, nous n'allons pas faire\ncela manuellement mais nous allons plut√¥t utiliser \n{{< fa brands r-project >}}. Effectuer ce type d'action de mani√®re\nmanuelle serait une mauvaise pratique du point de vue de la reproductibilit√©.\n\n```{r}\n#| echo: true\nurl <- \"https://minio.lab.sspcloud.fr/projet-formation/diffusion/python-datascientist/bike.csv\"\ndownload.file(url, \"bike.gz\") # <1>\n```\n1. L'extension `.gz` est importante pour la suite car `readr` en a besoin pour comprendre que le fichier est compress√©.\n\n## Premi√®res productions graphiques\n\nChercher √† produire une visualisation parfaite du premier coup est\nillusoire. Il est beaucoup plus r√©aliste d'am√©liorer graduellement \nune repr√©sentation graphique afin, petit √† petit, de mettre en \navant les effets de structure dans un jeu de donn√©es. \n\nNous allons donc commencer par nous repr√©senter la distribution\ndes passages aux principales stations de mesure.\nPour cela nous allons produire\nrapidement un _barplot_ puis l'am√©liorer graduellement. \n\n\nDans cette partie, nous allons ainsi\nreproduire les deux premiers graphiques de la\n[page d'analyse des donn√©es](https://opendata.paris.fr/explore/dataset/comptage-velo-donnees-compteurs/dataviz/?disjunctive.id_compteur&disjunctive.nom_compteur&disjunctive.id&disjunctive.name):\n*Les 10 compteurs avec la moyenne horaire la plus √©lev√©e* et *Les 10 compteurs ayant comptabilis√©s le plus de v√©los*. Les valeurs chiffr√©es des graphiques seront diff√©rentes de celles de la page en ligne, c'est normal, nous travaillons sur des donn√©es plus anciennes. \n\n\n[^1]: D'habitude, nous recommandons d'utiliser directement l'URL \nde t√©l√©chargement ce qui √©vite de cr√©er un fichier interm√©diaire\nsur le disque dur. N√©anmoins, ici, l'import direct avec `readr`\nne fonctionnera pas car le fichier est mal interpr√©t√© par la\nlibrairie. Celle-ci ne comprend pas que le fichier est compress√© car\nil lui manque l'extension `.gz` (un format compress√©) √† la fin. \n\n\n\n::: {.callout-tip}\n## Exercice 1 : Importer les donn√©es et produire un premier graphique rapidement\n\nLes donn√©es comportent plusieurs dimensions pouvant faire l'objet d'une \nanalyse statistique. Il est donc n√©cessaire dans un premier temps\nde synth√©tiser celles-ci par des agr√©gations afin d'avoir un\ngraphique lisible. \n\n1. Importer les donn√©es de compteurs de v√©los depuis le fichier `bike.gz` ;\n2. Garder les dix bornes √† la moyenne la plus √©lev√©e ;\n\n```{r}\n#| output: false\ndf <- readr::read_csv(\"bike.gz\")\n```\n\n\n```{r}\ndf1 <- df %>%\n  group_by(`Nom du compteur`) %>%\n  summarise(`Comptage horaire` = mean(`Comptage horaire`, na.rm = TRUE)) %>%\n  arrange(desc(`Comptage horaire`)) %>%\n  head(10)\n```\n\n<details>\n<summary>\nLes 10 principales stations √† l'issue de la question 2\n</summary>\n```{r}\nhead(df1)\n```\n</details>\n\nOn va maintenant pouvoir se concentrer sur la production de la \nrepr√©sentation\n\n3. En premier lieu, sans se pr√©occuper des √©l√©ments de style ni de la beaut√©\ndu graphique, cr√©er la structure du _barplot_ (diagramme en batons) de la\n[page d'analyse des donn√©es](https://opendata.paris.fr/explore/dataset/comptage-velo-donnees-compteurs/dataviz/?disjunctive.id_compteur&disjunctive.nom_compteur&disjunctive.id&disjunctive.name):\n\n<details>\n<summary>\nFigure obtenue, sans s'occuper du style\n</summary>\n```{r}\nggplot(df1, aes(y = `Nom du compteur`, x = `Comptage horaire`)) +\n  geom_bar(stat = \"identity\")\n```\n</details>\n\nLa suite de l'exercice consiste √† am√©liorer graduellement cette repr√©sentation\npour converger vers la reproduction de la version en _open data_. Il\nne s'agit pas encore de se concentrer sur l'esth√©tique de la figure mais\nde la rendre intelligible, √† gros trait. \n\n4. En premier lieu, r√©ordonner les barres sur l'axe des ordonn√©es\ngr√¢ce √† la fonction `reorder`. Cela rendra le message de la figure\nplus intelligible. \n\n<details>\n<summary>\nFigure avec les barres r√©ordonn√©es\n</summary>\n\n```{r}\nfigure1 <- ggplot(df1,\n       aes(y = reorder(`Nom du compteur`, `Comptage horaire`), # <1>\n           x = `Comptage horaire`)\n       ) +\n  geom_bar(stat = \"identity\")\nfigure1\n```\n1. On r√©ordonne `Nom du compteur` en fonction de `Comptage horaire`\n\n</details>\n\n\n5. Modifier votre couche esth√©tique afin\nd'appliquer une couleur rouge √† l'ensemble des barres\n\n<details>\n<summary>\nFigure avec les barres rouges\n</summary>\n\n```{r}\nfigure1 <- ggplot(df1,\n       aes(y = reorder(`Nom du compteur`, `Comptage horaire`), # <1>\n           x = `Comptage horaire`)\n       ) +\n  geom_bar(stat = \"identity\", fill = \"red\")\nfigure1\n```\n\n</details>\n\n:::\n\nOn commence √† avoir quelque chose qui commence √† transmettre\nun message synth√©tique sur la nature des donn√©es.\nOn peut n√©anmoins remarquer plusieurs √©l√©ments probl√©matiques\n(par exemple les labels) mais\naussi des √©l√©ments ne correspondant pas (les titres des axes, etc.) ou \nmanquants (le nom du graphique...)\n\n\n::: {.callout-tip}\n## Exercice 2 : Un peu de style !\n\nLa figure comporte maintenant un message mais il est encore peu\nlisible. \n\n1. Le minimum pour que quelqu'un ne connaissant pas les donn√©es soit\ncapable de comprendre la repr√©sentation graphique est de labelliser\nles axes. Cr√©er les m√™mes labels d'axes que la figure originale. \n\n<details>\n<summary>\nFigure avec les axes nomm√©s\n</summary>\n\n```{r}\nfigure1 <- figure1 + labs( # <1>\n  title = \"Les 10 compteurs avec la moyenne horaire la plus √©lev√©e\",\n  x = \"Nom du compteur\",\n  y = \"Moyenne horaire\"\n)\nfigure1\n```\n1. Il existe de nombreuses mani√®res de proc√©der avec `ggplot` pour labelliser\nles axes. Mais la plus simple est la fonction `labs`\n\n</details>\n\n\n2. Le fond gris permet est certes une marque distinctive que le graphique a √©t√©\nproduit avec `ggplot2` mais ce n'est pas tr√®s soign√©.\nUtiliser un th√®me plus minimaliste afin d'avoir un fond blanc.\n\n<details>\n<summary>\nFigure avec un fond blanc\n</summary>\n```{r}\nfigure1 <- figure1 +\n  theme_minimal()\nfigure1\n```\n\n</details>\n\n3. Maintenant, concentrons nous sur les √©l√©ments plus esth√©tiques.\nComme c'est une fonctionnalit√© un peu plus avanc√©e, nous proposons directement\nle code pour mettre √† jour votre figure avec les √©l√©ments de style\nsuivant:\n\n```r\ntheme(\n  axis.text.x = element_text(angle = 45, hjust = 1, color = \"red\"),\n  axis.title.x = element_text(color = \"red\"),\n  plot.title = element_text(hjust = 0.5),\n  plot.margin = margin(1, 4, 1, 1, \"cm\")\n)\n```\n\n<details>\n<summary>\nFigure obtenue √† l'issue de ces questions\n</summary>\n```{r}\nfigure1 <- figure1 +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1, color = \"red\"),\n    axis.title.x = element_text(color = \"red\"),\n    plot.title = element_text(hjust = 0.5),\n    plot.margin = margin(1, 4, 1, 1, \"cm\")\n    )\nfigure1\n```\n\n4. Enfin ajoutons de la complexit√© au graphique avec les chiffres sur\nles barres.\nEn vous aidant de ce [_post_](https://stackoverflow.com/questions/67767859/adding-text-on-each-bar-in-horizontal-bar-plot-in-ggplot), ajouter les comptages horaires moyens comme sur la\nfigure de l'_open data_ parisien[^annotation]\n\n```{r}\nfigure1 <- figure1 + \n  geom_text(\n    aes(label=round(`Comptage horaire`)),\n    position=position_dodge(width=0.9),\n    hjust=-0.5\n    )\n```\n\n[^annotation]: Ce n'est pas forc√©ment une bonne pratique de _dataviz_ de\nfaire cela. En effet, cela signifie que l'√©chelle et la diversit√©\ndes donn√©es dans celle-ci ne sont pas directement \nintelligibles. \n\n</details>\n\n:::\n\nOn comprend\nainsi que le boulevard de S√©bastopol est le plus emprunt√©,\nce qui ne vous suprendra pas si vous faites du v√©lo √† Paris. \nN√©anmoins, si vous n'√™tes pas familiers avec la g√©ographie parisienne,\ncela sera peu informatif pour vous, vous allez avoir besoin d'une\nrepr√©sentation graphique suppl√©mentaire: une carte ! Nous verrons\nceci lors d'un prochain chapitre. \n\n```{r}\n#| fig-cap: \"Les 10 compteurs avec la moyenne horaire la plus √©lev√©e\"\nfigure1\n```\n\n::: {.callout-tip}\n## Exercice 3: produire une nouvelle figure\n\nFaire la m√™me chose pour la figure 2 (_\"Les 10 compteurs ayant comptabilis√©s le plus de v√©los\"_), afin d'obtenir une figure similaire.\n\n<details>\n\n```{r}\ndf2 <- df %>%\n  group_by(`Nom du compteur`) %>%\n  summarise(`Comptage horaire` = sum(`Comptage horaire`, na.rm = TRUE)) %>%\n  arrange(desc(`Comptage horaire`)) %>%\n  head(10)\n```\n\n```{r}\n# Create a horizontal bar plot\nfigure2 <- ggplot(df2, aes(y = reorder(`Nom du compteur`, `Comptage horaire`), x = `Comptage horaire`)) +\n  geom_bar(stat = \"identity\", fill = \"forestgreen\") +\n  labs(title = \"Les 10 compteurs ayant comptabilis√©s le plus de v√©los\",\n       x = \"Nom du compteur\",\n       y = \"La somme des v√©los comptabilis√©s sur la p√©riode s√©lectionn√©e\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        axis.title.x = element_text(color = \"forestgreen\"),\n        plot.title = element_text(hjust = 0.5),\n        plot.margin = margin(1, 4, 1, 1, \"cm\"))\n```\n\n<summary>\nFigure 2 √† l'issue de cet exercice\n</summary>\n\n```{r}\nfigure2\n```\n\n</details>\n\n\n\n:::\n\n\nLes diagrammes en batons (_barplot_) sont extr√™mement communs mais \nqu'ils transmettent. Sur le plan s√©miologique,\nles _lollipop charts_ sont pr√©f√©rables: ils\ntransmettent la m√™me information mais avec moins de bruit\n(la largeur des barres du barplot noie un peu l'information).\n\nVoici, par exemple, la deuxi√®me figure de la page, rendue non plus\nsous forme de _barplot_ mais sous forme de _lollipop chart_:\n\n\n```{r}\ndf2_lollipop <- df2 %>%\n  mutate(x =  fct_reorder(`Nom du compteur`, `Comptage horaire` ), y = `Comptage horaire`)\n\nfigure2_lollipop <- ggplot(df2_lollipop, aes(x=x, y=y)) +\n    geom_segment( aes(xend=x, yend=0), alpha = 0.4) +\n    geom_point( size=5, color=\"forestgreen\") +\n    coord_flip() +\n  labs(title = \"Les 10 compteurs ayant comptabilis√©s le plus de v√©los\",\n       x = \"Nom du compteur\",\n       y = \"La somme des v√©los comptabilis√©s sur la p√©riode s√©lectionn√©e\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        axis.title.x = element_text(color = \"forestgreen\"),\n        plot.title = element_text(hjust = 0.5),\n        plot.margin = margin(1, 4, 1, 1, \"cm\")) +\n  scale_y_continuous(labels = unit_format(unit = \"M\", scale=1e-6))\n```\n\n```{r}\nfigure2_lollipop\n```\n\n<details>\n<summary>\nComparaison du _barplot_ et du _lollipop chart_\n</summary>\n```{r}\n#| layout-ncol: 2\n#| fig-cap: \"Choisissez votre repr√©sentation pr√©f√©r√©e\"\n#| fig-subcap: \n#|   - \"Barplot\"\n#|   - \"Lollipop\"\nfigure2\nfigure2_lollipop\n```\n</details>\n\n\n::: {.callout-tip}\n## Exercice 3 bis (optionnel): produire un _lollipop_ chart\n\nReprendre l'exercice 2 mais √† la place d'un _barplot_, produire\nun _lollipop chart_.  \n::: \n\n## Premi√®re agr√©gation temporelle\n\nOn va maintenant se concentrer sur la dimension spatiale de notre\njeu de donn√©es √† travers deux approches:\n\n- Un diagramme en barre synth√©tisant l'information de notre jeu de donn√©es\nde mani√®re mensuelle ;\n- Des s√©ries instructives sur la dynamique temporelle. Cela sera l'objet de la prochaine partie ;\n\n\nPour commencer, reproduisons la troisi√®me figure qui est, encore une fois, \nun _barplot_. La premi√®re question implique une premi√®re rencontre avec\nune donn√©e temporelle √† travers une op√©ration assez classique en s√©ries\ntemporelles: changer le format d'une date pour pouvoir faire une agr√©gation\n√† un pas de temps plus large. \n\n::: {.callout-tip}\n## Exercice 4: barplot des comptages mensuels\n\n1. Utiliser la fonction `format` pour cr√©er une variable `month`\ndont le format respecte, par exemple, le sch√©ma `2019-08` ;\n2. Faire la moyenne des comptages horaires pour chaque mois\n\n```{r}\ndf <- df %>%\n  mutate(month = format(`Date et heure de comptage`, \"%Y-%m\"))\n```\n\n```{r}\n# Question 2\ncomptage_horaires_mois <- df %>%\n  group_by(month) %>%\n  summarise(value = mean(`Comptage horaire`, na.rm = TRUE))\n```\n\n<details>\n<summary>\nComptages horaires obtenus √† l'issue de cette question\n</summary>\n\n```{r}\ncomptage_horaires_mois\n```\n\n</details>\n\nAppliquer les conseils pr√©c√©dents pour construire et am√©liorer\ngraduellement un graphique afin d'obtenir une figure similaire\n√† la 3e production sur la page de l'_open data_ parisien.\n\n```{r}\nfigure3 <- ggplot(comptage_horaires_mois) +\n  geom_bar(aes(x = month, y = value), fill = \"#ffcd00\", stat = \"identity\") +\n  labs(x = \"Date et heure de comptage\", y = \"Moyenne mensuelle du comptage par heure\\nsur la p√©riode s√©lectionn√©e\",\n       title = \"Moyenne mensuelle des comptages v√©los\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        axis.title.y = element_text(color = \"#ffcd00\", face = \"bold\"),\n        plot.title = element_text(hjust = 0.5),\n        plot.margin = margin(1, 4, 1, 1, \"cm\"))\n```\n\n<details>\n<summary>\nExemple de figure reproduisant l'_open data_ parisien\n</summary>\n\n```{r}\nfigure3\n```\n\n</details>\n\n- Question optionnelle: repr√©senter la m√™me information sous forme de _lollipop_\n\n:::\n\n\n```{r}\nfigure3\n```\n\nSi vous pr√©f√©rez repr√©senter cela sous forme de _lollipop_[^notecouleur]:\n\n```{r}\nggplot(comptage_horaires_mois, aes(x = month, y = value)) +\n  geom_segment(aes(xend = month, yend = 0)) +\n  geom_point( color=\"#ffcd00\", size=4) +\n  labs(x = \"Date et heure de comptage\", y = \"Moyenne mensuelle du comptage par heure\\nsur la p√©riode s√©lectionn√©e\",\n       title = \"Moyenne mensuelle des comptages v√©los\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        #axis.title.y = element_text(color = \"#ffcd00\", face = \"bold\"),\n        plot.title = element_text(hjust = 0.5),\n        plot.margin = margin(1, 4, 1, 1, \"cm\"))\n```\n\n[^notecouleur]: J'ai retir√© la couleur sur l'axe des ordonn√©es qui, je trouve,\napporte peu √† la figure voire d√©grade la compr√©hension du message. \n\n\n## Premi√®re s√©rie temporelle\n\nIl est plus commun de repr√©senter sous forme de s√©rie\nles donn√©es ayant une dimension temporelle.\n\n\n::: {.callout-tip}\n## Exercice 5: Repr√©senter une s√©rie temporelle\n\n1. Cr√©er une variable `day` qui transforme l'horodatage en format journalier\ndu type `2021-05-01`.\n\n```{r}\ndf <- df %>%\n  mutate(day = date(`Date et heure de comptage`))\n\nmoyenne_quotidienne <- df %>%\n  group_by(day) %>%\n  summarise(value = mean(`Comptage horaire`, na.rm = TRUE))\n```\n\n2. Repr√©senter sous forme de s√©rie temporelle cette information, sans vous\npr√©occuper du style de la figure.\n\n```{r}\nfigure4 <- ggplot(moyenne_quotidienne, aes(x = day, y = value)) +\n  geom_line(color = \"magenta\")\n```\n\n<details>\n<summary>\nFigure minimaliste\n</summary>\n```{r}\nfigure4\n```\n</details>\n\n3. Colorer la zone sous la ligne avec la fonction appropri√©e\n\n```{r}\nfigure4 <- figure4 +\n  geom_area(fill=\"magenta\", alpha = 0.6)\n```\n\n<details>\n<summary>\nFigure avec la coloration sous la ligne\n</summary>\n```{r}\nfigure4\n```\n</details>\n\n4. Finaliser le graphique pour reproduire la figure de la page d'_open data_\n\n```{r}\nfigure4 <- figure4 +\n  labs(x = \"Date et heure de comptage (Jour)\", y = \"Moyenne journali√®re du comptage par heure\\nsur la p√©riode s√©lectionn√©e\",\n       title = \"Moyenne journali√®re des comptages v√©los\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        plot.title = element_text(hjust = 0.5),\n        plot.margin = margin(1, 4, 1, 1, \"cm\"))\n```\n\n<details>\n<summary>\nFigure finalis√©e\n</summary>\n```{r}\nfigure4\n```\n</details>\n\nVoici quelques aides pour cet exercice\n\n\n<details>\n<summary>\nüí° Aide pour la question 1\n</summary>\nRegardez la fonction `day` du _package_ `lubridate`\n</details>\n\n<details>\n<summary>\nüí° Aide pour la question 3\n</summary>\n[Ce _thread_ sur `stackoverflow`](https://stackoverflow.com/questions/28730083/filling-in-the-area-under-a-line-graph-in-ggplot2-geom-area) peut vous aider.\n</details>\n\n\n<details>\n<summary>\nLe jeu de donn√©es pour la figure 4\n</summary>\n```{r}\nhead(moyenne_quotidienne)\n```\n</details>\n\n:::\n\nA l'issue de cet exercice, on obtient ainsi une figure prenant la forme\nsuivante:\n\n```{r}\nfigure4\n```\n\n\n## Introduction aux graphiques HTML avec `Plotly`\n\nL'inconv√©nient des figures avec `ggplot` est que celles-ci ne permettent\npas d'interaction avec le lecteur. Toute l'information doit donc √™tre\ncontenue dans la figure ce qui peut la rendre difficile √† lire. \nSi la figure est bien faite, avec diff√©rents niveaux d'information, cela\npeut bien fonctionner.\n\nIl est n√©anmoins plus simple, gr√¢ce aux technologies _web_, de proposer des\nvisualisations √† plusieurs niveaux. Un premier niveau d'information, celui du\ncoup d'oeil, peut suffire √† assimiler les principaux messages de la\nvisualisation. Ensuite, un comportement plus volontaire de recherche\nd'information secondaire peut permettre d'en savoir plus. Les visualisations\nr√©actives, qui sont maintenant la norme dans le monde de la _dataviz_, \npermettent ce type d'approche: le lecteur d'une visualisation peut passer\nsa souris √† la recherche d'information compl√©mentaire (par exemple les\nvaleurs exactes) ou cliquer pour faire appara√Ætre des informations compl√©mentaires\nsur la visualisation ou autour.\n\nCes visualisations reposent sur le m√™me triptyque que l'ensemble de l'√©cosyst√®me\n_web_: `HTML`, `CSS` et `JavaScript`. Les utilisateurs de {{< fa brands r-project >}} \nne vont jamais manipuler directement ces langages, qui demandent une \ncertaine expertise, mais vont utiliser des librairies au niveau de {{< fa brands r-project >}} qui g√©n√®reront automatiquement tout le code `HTML`, `CSS` et `JavaScript`\npermettant de cr√©er la figure. \n\n::: {.callout-tip}\n## Exercice 6: s√©rie temporelle interactive\n\n1. Cr√©er une figure `Plotly` basique pour repr√©senter\nsous forme de s√©rie temporelle la figure 4, sans se pr√©occuper du style\n\n<details>\n<summary>\nS√©rie temporelle produite sans √©l√©ment de style\n</summary>\n```{r}\nplot_ly(\n  moyenne_quotidienne, x = ~day, y = ~value,\n  type = 'scatter', mode = 'lines'\n)\n```\n</details>\n\n\n2. A partir de l'exemple dans la [documentation](https://plotly.com/r/filled-area-plots/),\najouter une aire sous la figure\n\n<details>\n<summary>\nAjout de la couche sous la ligne\n</summary>\n\n```{r}\nplot_ly(\n  moyenne_quotidienne, x = ~day, y = ~value,\n  fill = 'tozeroy',\n  type = 'scatter', mode = 'lines'\n)\n```\n</details>\n\n\n3. Jouer sur les √©l√©ments de style pour reproduire la figure 4. Pour profiter\nde la r√©activit√© du graphique, soigner l'information obtenue en passant\nla souris sur la figure gr√¢ce aux arguments `hovertemplate` et `hoverinfo`\n\n```{r}\nfig <- plot_ly(\n  moyenne_quotidienne, x = ~day, y = ~value,\n  color = I(\"magenta\"),\n  hovertemplate = ~paste(day, \": \", round(value), \" passages de v√©lo en moyenne par heure\"),\n  hoverinfo = \"text\",\n  fill = 'tozeroy',\n  type = 'scatter', mode = 'lines')\nfig4 <- fig %>%\n  layout(title = \"Moyenne journali√®re des comptages v√©los\",\n         xaxis = list(title = \"Date et heure de comptage (Jour)\"),\n         yaxis = list(title = \"Moyenne journali√®re du comptage par heure\\nsur la p√©riode s√©lectionn√©e\"))\n```\n\n\n<details>\n<summary>\nFigure obtenue\n</summary>\n\n```{r}\nfig4\n```\n\n</details>\n\n:::\n\n\nLa version r√©active de la figure est ainsi\n\n```{r}\nfig4\n```\n\n\nCette repr√©sentation montre bien le caract√®re sp√©cial de l'ann√©e 2020. Pour \nrappeller au lecteur distrait la nature particuli√®re de la p√©riode, marqu√©e\npar un premier confinement qu'on voit bien dans les donn√©es, on peut,\navec l'aide de la [documentation](https://plotly.com/r/horizontal-vertical-shapes/),\najouter deux barres verticales pour marquer les dates de d√©but et\nde fin de cette p√©riode:\n\n\n```{r}\n#| echo: true\nvline <- function(x = 0, color = \"royalblue\") {\n  list(\n    type = \"line\",\n    y0 = 0,\n    y1 = 1,\n    yref = \"paper\",\n    x0 = x,\n    x1 = x,\n    line = list(color = color, dash=\"dot\")\n  )\n}\n\nfig4 %>% layout(shapes = list(vline(\"2020-03-17\"), vline(\"2020-05-11\")))\n```\n\nComme dernier exercice, voici comment reproduire cette figure avec \n`Plotly`:\n\n```{r}\ndf1 <- df1 %>% mutate(`Nom du compteur` = fct_reorder(`Nom du compteur`, `Comptage horaire`))\n\nfig <- plot_ly(\n  df1,\n  x = ~ `Comptage horaire`, y = ~`Nom du compteur`,\n  color = I(\"red\"),\n  hovertext = ~paste0(`Nom du compteur`, \": \", round(`Comptage horaire`)),\n  hoverinfo = 'text',\n  type = 'bar',\n  name = 'Principales stations')\n\n\nfig <- fig %>% layout(\n  yaxis = list(title = 'Moyenne horaire'),\n  xaxis = list(title = 'Nom du compteur', color = \"red\")\n  )\n```\n\n\n```{r}\nfig\n```\n\n::: {.callout-tip}\n## Exercice 7: un barplot avec `Plotly`\n\n1. Pour avoir imm√©diatement des barres bien ordonn√©es, utiliser la fonction\n`fct_reorder` du package `forcats` pour r√©oordonner les valeurs du dataframe\nissu de l'exercice 1\n2. Utiliser `Plotly` pour cr√©er votre figure.\n3. (Optionnel, plus avanc√©) Faire un _lollipop chart_ avec `Plotly`\n:::\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":true,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../styles.css"],"toc":true,"number-sections":true,"output-file":"ggplot.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.8.27","author":"Lino Galiana","theme":"cosmo","code-annotations":"hover","title":"Produire des repr√©sentations graphiques avec {{< fa brands r-project >}} et `ggplot2`"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}