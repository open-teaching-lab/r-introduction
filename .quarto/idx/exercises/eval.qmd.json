{"title":"Evaluation","markdown":{"yaml":{"title":"Evaluation","echo":false,"output":false},"headingText":"Consignes g√©n√©rales","containsRefs":false,"markdown":"\n\nCe chapitre pr√©sente la consigne pour l'√©valuation de l'ann√©e 2023-2024.\n\nL'objectif de ces exercices est de vous amener √† explorer la richesse\ndes donn√©es\n√©lectorales fines. Vous pourrez ult√©rieurement aller plus loin pour \nessayer de relier les r√©sultats de vote √† des variables socio√©conomiques\ndisponibles √† la m√™me √©chelle. \n\nLes consignes g√©n√©rales sont les suivantes:\n\n::: {.callout-tip}\n\n- Envoyer par mail avant le __XX janvier 2024__ deux documents: un fichier `.qmd`\nreproductible m√©langeant vos r√©ponses aux questions et vos analyses et\nle `.html` g√©n√©r√© gr√¢ce √† celui-ci ;\n- Le `.html` ne pr√©sente pas les exemples de code, pensez donc √† mettre\n`echo: false` dans les options du _header_ ;\n- N'oubliez pas d'ajouter les informations personnelles standards (auteur, titre)\ndans votre document ;\n- Essayez de soigner le `.html` rendu. Vous pouvez n√©anmoins avoir\ndes sorties graphiques ou tableau au style diff√©rent de ceux que j'ai mis en\nexemple si vous avez envie de donner une touche personnelle √† votre rapport ;\n- Le document `.qmd` doit √™tre reproductible, c'est-√†-dire que si je clique\nsur le bouton `Render`, cela va fonctionner. \n:::\n\n\n```{r}\nlibrary(readr)\nlibrary(dplyr)\nlibrary(gt)\nlibrary(gtExtras)\nlibrary(cartiflette)\nlibrary(stringr)\nlibrary(ggplot2)\nlibrary(scales)\nlibrary(svglite)\n```\n\nLe code d'import des donn√©es est directement mis √† disposition \npour vous permettre de d√©marrer les exercices.\n\n```{r}\n#| echo: true\ndf <- read_csv(\n  'https://www.data.gouv.fr/fr/datasets/r/182268fc-2103-4bcb-a850-6cf90b02a9eb'\n)\n```\n\n## Explorations g√©n√©rales\n\n::: {.callout-tip}\n## Question 1\n\nCr√©er ou mettre √† jour les variables suivantes:\n\n  - `code_commune`: En utilisant la variable d√©j√† existante et le d√©partement, remplacer la valeur `code_commune` pour constituer un vrai code commune. Par exemple, pour Montrouge, vous devriez obtenir `92049`. \n  - `candidat`: cr√©er une colonne avec le `prenom` et le `nom` mis ensemble, en n'oubliant pas de mettre un espace. Ne pas √©liminer les bulletins abstentions, blancs ou nuls, nous allons les exploiter ult√©rieurement. \n\n```{r}\ndf <- df %>% mutate(\n  code_commune = paste0(code_departement, code_commune),\n  candidat = paste0(paste0(prenom, ' ', nom))\n)\n```\n:::\n\n\n::: {.callout-tip}\n## Exercice 2\n\nCompl√©ter la phrase suivante gr√¢ce √† `R`:\n\n> En 2022, il y avait XXXXX candidats √† l'√©lection pr√©sidentielle\n\nL'int√©grer dans un code _inline_ pour obtenir la phrase comme ci-dessous\n\n_Note: Attention aux [votes non exprim√©s](https://www.conseil-constitutionnel.fr/referendum-traite-constitution-pour-l-europe/bulletins-blancs-et-nuls) et aux abstentions_\n:::\n\n\n\n```{r}\ncandidats <- df %>%\n  filter(!is.na(prenom)) %>%\n  summarise(candidats = n_distinct(candidat)) %>%\n  as.numeric()\n```\n\n\nEn 2022, il y avait __`r candidats`__ candidats √† l'√©lection pr√©sidentielle.\n\n\n\n::: {.callout-tip}\n## Question 3\n\nCalculer les scores nationaux de chaque candidat. Repr√©senter dans ce tableau,\npour chaque candidat, le nombre de voix et le pourcatage des votes exprim√©s\n(c'est-√†-dire en retirant abstentions et votes non exprim√©s). \n\nUtiliser `gt` pour repr√©senter cela dans un tableau, par exemple dans le style\nde celui disponible plus bas (il n'est pas obligatoire d'aller aussi loin\ndans la mise en forme mais essayez d'obtenir un beau tableau tout de m√™me).\n\n_Note: vous pouvez contr√¥ler vos r√©sultats obtenus avec [cette page](https://www.gouvernement.fr/actualite/election-presidentielle-les-resultats-du-premier-tour)_\n\n:::\n\n```{r}\ntableau_resultats <- df %>%\n  filter(!is.na(prenom)) %>%\n  group_by(candidat) %>%\n  summarise(votes = sum(voix)) %>%\n  mutate(score = votes/sum(votes)) %>%\n  arrange(desc(score))\n```\n\n_Exemple de tableau √† obtenir_:\n\n```{r}\n#| output: true\ngt(tableau_resultats %>% mutate(color = \"\", score2 = 100*score)) %>%\n  fmt_integer(columns = votes, locale = \"fr\") %>%\n  fmt_percent(columns = score) %>%\n  gt_plt_bar_pct(\n    column = score2, scaled = TRUE\n  ) %>%\n  cols_label(\n    votes = \"Nombre votes (total)\",\n    score = \"Score (% votes exprim√©s)\",\n    candidat = \"Candidat.e\",\n    color = \"\",\n    score2 = \"\"\n    ) %>%\n  data_color(columns = c('score'), target_columns = color, method = \"numeric\", palette = \"PuOr\") %>%\n  tab_header(\n    title = md(\"__Elections üá´üá∑__\"),\n    subtitle = md(\"R√©sultats du premier tour (üìÖ _10 avril 2022_)\")\n  ) %>%\n  tab_style(\n    style = cell_text(weight = \"bold\", align = \"center\"),\n    locations = cells_column_labels()\n  )\n```\n\n\n```{r}\n#| eval: false\n\n# Calculer pour les d√©partements de la petite couronne,\n# les scores de E. Macron, M. Le Pen. agr√©ger les votes restants en autre\nvotes_idf_top3 <- df %>%\n  filter(!is.na(prenom)) %>%\n  filter(code_departement %in% c(75,92,93,94)) %>%\n  mutate(candidat2 = if_else(\n    nom %in% c(\"MACRON\", \"LE PEN\"),\n    candidat, \"Autres candidats\")) %>%\n  group_by(code_departement, candidat2) %>%\n  summarise(votes = sum(voix)) %>%\n  group_by(code_departement) %>% \n  mutate(score = votes/sum(votes))\n\nvotes_idf_top3 <- votes_idf_top3 %>%\n  group_by(code_departement) %>%\n  summarize(list_data = list(score))\n\ngt(votes_idf_top3) %>%\n  gt_plt_bar_stack(list_data, width = 65,\n                   labels = c(\"Autres candidats\", \"Macron\", \"Le Pen\"),\n                   palette= c(\"#bfbfbf\", \"#ff4343\", \"#0a1c2b\"))\n```\n\n## Comparaison des scores d√©partements aux moyennes nationales. \n\nOn va essayer d'√©tudier la territorialit√© de certains votes. Pour cela, nous\nallons √©tudier la mani√®re dont certains candidats sont surrepr√©sent√©s dans\nles r√©sultats par rapport √† leur moyenne nationale. \n\n\n::: {.callout-tip}\n## Question 4\n\nCr√©er un _dataframe_ nomm√© `score_departements` stockant, pour chaque\nd√©partement, le nombre de vote obtenu pour chaque candidat et \nle score (en %). \n\n```{r}\nscore_departements <- df %>%\n  filter(!is.na(prenom)) %>%\n  group_by(code_departement, candidat) %>%\n  summarise(votes = sum(voix)) %>%\n  mutate(score = votes/sum(votes)) \n```\n\nPar exemple, vous devriez obtenir le r√©sultat suivant pour l'Aude:\n\n\n```{r}\n#| output: true\nscore_departements %>% filter(code_departement == 11)\n```\n\n:::\n\n\n::: {.callout-tip}\n## Question 5\n\nRefaire le lien avec le niveau national pour comparer le score\nd√©partemental avec le score national. Nommer ce _dataframe_\n`score_departements`, nous allons le r√©utiliser par la suite. \n\n```{r}\nscore_departements <- score_departements %>%\n  left_join(\n    tableau_resultats,\n    by = \"candidat\",\n    suffix = c(\"_departement\", \"_national\")\n  )\n```\n\nPar exemple, vous devriez obtenir le r√©sultat suivant pour l'Aude:\n\n\n```{r}\n#| output: true\nscore_departements %>% filter(code_departement == 11)\n```\n\n:::\n\n\n::: {.callout-tip}\n## Question 6\n\nCr√©er une variable `surrepresentation` qui compare, en relatif, \nles scores nationaux et d√©partementaux.\n\nPar exemple, si un candidat a un score de 30% dans un d√©partement\nmais de 15% ailleurs, la valeur de `surrepresentation` sera √©gale √† 100 (%).\n\n\n```{r}\nscore_departements <- score_departements %>%\n  mutate(surrepresentation = 100*(score_departement/score_national - 1))\n```\n\n:::\n\n::: {.callout-tip}\n## Question 7\n\nObserver les 5 principales repr√©sentations, en valeur absolue,\npour chaque candidat. Repr√©senter cela sur un graphique, \ndu type de celui-ci dessous.\n\n```{r}\n#| output: true\nscore_departements_top <- score_departements %>%\n  arrange(candidat, desc(abs(surrepresentation))) %>%\n  group_by(candidat) %>%\n  filter(row_number() <= 5)\n\nggplot(score_departements_top) +\n  geom_bar(aes(x = surrepresentation, y = factor(code_departement)), stat = \"identity\") +\n  facet_wrap(~candidat, scales = \"free\")\n```\n\n:::\n\n\n## Un peu de cartographie\n\nPour cette partie, vous pouvez r√©cup√©rer le fond de carte\ndes d√©partements gr√¢ce au code ci-dessous:\n\n```{r}\n#| echo: true\ndepartement_borders <- download_vectorfile_url_all(\n  crs = 4326,\n  values = \"metropole\",\n  borders=\"DEPARTEMENT\",\n  vectorfile_format=\"geojson\",\n  filter_by=\"FRANCE_ENTIERE\",\n  source=\"EXPRESS-COG-CARTO-TERRITOIRE\",\n  year=2022)\n```\n\n\n::: {.callout-tip}\n## Question 8a\n\nRestreindre `score_departements` aux r√©sultats de Marine Le Pen (ne pas √©craser\n`score_departements` nous allons l'utiliser √† nouveau !). Faire une jointure\nau fond de carte des d√©partements et effectuer une carte de la repr√©sentation. \nL'√©chelle de couleur que vous pouvez utiliser est `white` pour les valeurs les\nplus basses et `#394679` pour les valeurs les plus hautes.\n\nInterpr√©ter.\n\n:::\n\n```{r}\nscore_departements_mlp <- score_departements %>%\n  filter(candidat == \"Marine LE PEN\")\n\ndepartement_borders_mlp <- departement_borders %>%\n  left_join(score_departements_mlp, by = c(\"INSEE_DEP\" = \"code_departement\"))\n```\n\n\nVous devriez obtenir une carte proche de celle-ci\n\n```{r}\n#| output: true\nggplot(departement_borders_mlp) +\n  geom_sf(aes(fill = surrepresentation)) +\n  scale_fill_steps(\n    n.breaks = 5,\n    low = \"white\", high = \"#394679\",\n    labels = label_number(scale_cut = cut_short_scale())\n  ) +\n  theme_void()  +\n  labs(fill = \"(% par rapport\\nmoyenne nationale)\")\n```\n\n\n\n::: {.callout-tip}\n## Question 8b\n\nM√™me question pour Emmanuel Macron. \nL'√©chelle de couleur que vous pouvez utiliser est `white` pour les valeurs les\nplus basses et `#f1c237` pour les valeurs les plus hautes.\n\nInterpr√©ter.\n\n:::\n\n\n```{r}\nscore_departements_em <- score_departements %>%\n  filter(candidat == \"Emmanuel MACRON\")\n\ndepartement_borders_em <- departement_borders %>%\n  left_join(score_departements_em, by = c(\"INSEE_DEP\" = \"code_departement\"))\n```\n\n```{r}\n#| output: true\nggplot(departement_borders_em) +\n  geom_sf(aes(fill = surrepresentation)) +\n  scale_fill_steps(\n    n.breaks = 5,\n    low = \"white\", high = \"#f1c237\",\n    labels = label_number(scale_cut = cut_short_scale())\n  ) +\n  theme_void()  +\n  labs(fill = \"(% par rapport\\nmoyenne nationale)\")\n```\n\n::: {.callout-tip}\n## Question 8c\n\nM√™me question pour Jean-Luc M√©lenchon. \nL'√©chelle de couleur que vous pouvez utiliser est `white` pour les valeurs les\nplus basses et `#cb452a` pour les valeurs les plus hautes.\n\nInterpr√©ter.\n\n:::\n\n\n```{r}\nscore_departements_jlm <- score_departements %>%\n  filter(candidat == \"Jean-Luc M√âLENCHON\")\n\ndepartement_borders_jlm <- departement_borders %>%\n  left_join(score_departements_jlm, by = c(\"INSEE_DEP\" = \"code_departement\"))\n```\n\n```{r}\n#| output: true\nggplot(departement_borders_jlm) +\n  geom_sf(aes(fill = surrepresentation)) +\n  scale_fill_steps(\n    n.breaks = 5,\n    low = \"white\", high = \"#cb452a\",\n    labels = label_number(scale_cut = cut_short_scale())\n  ) +\n  theme_void()  +\n  labs(fill = \"(% par rapport\\nmoyenne nationale)\")\n```\n\n\n## Focus sur l'abstention\n\n::: {.callout-tip}\n# Question 9\n\nRetrouver les 10 principales communes abstentionnistes parmi les \ncommunes o√π il y a eu plus de 2000 votes et n'appartenant pas\naux d√©partements des DROM ou des Fran√ßais √† l'√©tranger\n(pour cela, le filtre est\ndirectement donn√©: `filter(!str_starts(code_commune, \"(fr|98|97)\"))`.\n\nAnalyser\n\n:::\n\n\n```{r}\nabstention <- df %>%\n  mutate(abstention = if_else(nom == \"abstentions\", \"Abstentions\", \"Exprim√©s\")) %>%\n  group_by(code_commune, libelle_commune, abstention) %>%\n  summarise(votes = sum(voix)) %>%\n  group_by(code_commune, libelle_commune) %>%\n  mutate(taux_abstention = votes/sum(votes)) %>%\n  filter(\n    abstention == \"Abstentions\", !str_starts(code_commune, \"(fr|98|97)\"),\n    votes > 2000\n    ) %>%\n  arrange(desc(taux_abstention))\n```\n\n\nLe tableau √† obtenir sera le suivant. Le votre devra avoir au moins une colonne\nsuppl√©mentaire: les noms de commune. \n\n```{r}\n#| output: true\nabstention %>%\n    select(-one_of(\"libelle_commune\"))\n```\n\n\n\n### L'abstention en Corse\n\nVoici le code pour r√©cup√©rer le fond de carte des communes Corse.\n\n\n```{r}\n#| echo: true\ncorse <- download_vectorfile_url_all(\n  crs = 4326,\n  values = c(\"2A\",\"2B\"),\n  borders=\"COMMUNE\",\n  vectorfile_format=\"geojson\",\n  filter_by=\"DEPARTEMENT\",\n  source=\"EXPRESS-COG-CARTO-TERRITOIRE\",\n  year=2022)\n```\n\n::: {.callout-note}\n\nFaire une carte du taux d'abstention par commune en Corse. Vous\npouvez la faire figer avec ggplot ou mapsf ou, si vous pr√©f√©rez,\nr√©active avec leaflet.\n:::\n\n\n\n```{r}\nabstention_corse <- df %>%\n  mutate(abstention = if_else(nom == \"abstentions\", \"Abstentions\", \"Exprim√©s\")) %>%\n  group_by(code_commune, libelle_commune, abstention) %>%\n  summarise(votes = sum(voix)) %>%\n  group_by(code_commune, libelle_commune) %>%\n  mutate(taux_abstention = votes/sum(votes)) %>%\n  filter(str_starts(code_commune,'(2A|2B)'), abstention == \"Abstentions\") %>%\n  mutate(code_commune_propre = str_sub(code_commune, 3, -1))\n\n\ncorse_enrichie <- corse %>% inner_join(abstention_corse, by = c(\"INSEE_COM\" = \"code_commune\"))\n```\n\nLa carte obtenue devrait ressembler √† celle-ci:\n\n\n```{r}\n#| output: true\nggplot(corse_enrichie) +\n  geom_sf(aes(fill = taux_abstention)) +\n  scale_fill_fermenter(\n    n.breaks = 5,\n    palette = \"RdPu\",\n    direction = 1,\n    labels = label_number(scale_cut = cut_short_scale())\n  ) +\n  theme_void() +\n  labs(fill = \"Taux d'abstention\")\n```\n\n","srcMarkdownNoYaml":"\n\nCe chapitre pr√©sente la consigne pour l'√©valuation de l'ann√©e 2023-2024.\n\nL'objectif de ces exercices est de vous amener √† explorer la richesse\ndes donn√©es\n√©lectorales fines. Vous pourrez ult√©rieurement aller plus loin pour \nessayer de relier les r√©sultats de vote √† des variables socio√©conomiques\ndisponibles √† la m√™me √©chelle. \n\nLes consignes g√©n√©rales sont les suivantes:\n\n::: {.callout-tip}\n## Consignes g√©n√©rales\n\n- Envoyer par mail avant le __XX janvier 2024__ deux documents: un fichier `.qmd`\nreproductible m√©langeant vos r√©ponses aux questions et vos analyses et\nle `.html` g√©n√©r√© gr√¢ce √† celui-ci ;\n- Le `.html` ne pr√©sente pas les exemples de code, pensez donc √† mettre\n`echo: false` dans les options du _header_ ;\n- N'oubliez pas d'ajouter les informations personnelles standards (auteur, titre)\ndans votre document ;\n- Essayez de soigner le `.html` rendu. Vous pouvez n√©anmoins avoir\ndes sorties graphiques ou tableau au style diff√©rent de ceux que j'ai mis en\nexemple si vous avez envie de donner une touche personnelle √† votre rapport ;\n- Le document `.qmd` doit √™tre reproductible, c'est-√†-dire que si je clique\nsur le bouton `Render`, cela va fonctionner. \n:::\n\n\n```{r}\nlibrary(readr)\nlibrary(dplyr)\nlibrary(gt)\nlibrary(gtExtras)\nlibrary(cartiflette)\nlibrary(stringr)\nlibrary(ggplot2)\nlibrary(scales)\nlibrary(svglite)\n```\n\nLe code d'import des donn√©es est directement mis √† disposition \npour vous permettre de d√©marrer les exercices.\n\n```{r}\n#| echo: true\ndf <- read_csv(\n  'https://www.data.gouv.fr/fr/datasets/r/182268fc-2103-4bcb-a850-6cf90b02a9eb'\n)\n```\n\n## Explorations g√©n√©rales\n\n::: {.callout-tip}\n## Question 1\n\nCr√©er ou mettre √† jour les variables suivantes:\n\n  - `code_commune`: En utilisant la variable d√©j√† existante et le d√©partement, remplacer la valeur `code_commune` pour constituer un vrai code commune. Par exemple, pour Montrouge, vous devriez obtenir `92049`. \n  - `candidat`: cr√©er une colonne avec le `prenom` et le `nom` mis ensemble, en n'oubliant pas de mettre un espace. Ne pas √©liminer les bulletins abstentions, blancs ou nuls, nous allons les exploiter ult√©rieurement. \n\n```{r}\ndf <- df %>% mutate(\n  code_commune = paste0(code_departement, code_commune),\n  candidat = paste0(paste0(prenom, ' ', nom))\n)\n```\n:::\n\n\n::: {.callout-tip}\n## Exercice 2\n\nCompl√©ter la phrase suivante gr√¢ce √† `R`:\n\n> En 2022, il y avait XXXXX candidats √† l'√©lection pr√©sidentielle\n\nL'int√©grer dans un code _inline_ pour obtenir la phrase comme ci-dessous\n\n_Note: Attention aux [votes non exprim√©s](https://www.conseil-constitutionnel.fr/referendum-traite-constitution-pour-l-europe/bulletins-blancs-et-nuls) et aux abstentions_\n:::\n\n\n\n```{r}\ncandidats <- df %>%\n  filter(!is.na(prenom)) %>%\n  summarise(candidats = n_distinct(candidat)) %>%\n  as.numeric()\n```\n\n\nEn 2022, il y avait __`r candidats`__ candidats √† l'√©lection pr√©sidentielle.\n\n\n\n::: {.callout-tip}\n## Question 3\n\nCalculer les scores nationaux de chaque candidat. Repr√©senter dans ce tableau,\npour chaque candidat, le nombre de voix et le pourcatage des votes exprim√©s\n(c'est-√†-dire en retirant abstentions et votes non exprim√©s). \n\nUtiliser `gt` pour repr√©senter cela dans un tableau, par exemple dans le style\nde celui disponible plus bas (il n'est pas obligatoire d'aller aussi loin\ndans la mise en forme mais essayez d'obtenir un beau tableau tout de m√™me).\n\n_Note: vous pouvez contr√¥ler vos r√©sultats obtenus avec [cette page](https://www.gouvernement.fr/actualite/election-presidentielle-les-resultats-du-premier-tour)_\n\n:::\n\n```{r}\ntableau_resultats <- df %>%\n  filter(!is.na(prenom)) %>%\n  group_by(candidat) %>%\n  summarise(votes = sum(voix)) %>%\n  mutate(score = votes/sum(votes)) %>%\n  arrange(desc(score))\n```\n\n_Exemple de tableau √† obtenir_:\n\n```{r}\n#| output: true\ngt(tableau_resultats %>% mutate(color = \"\", score2 = 100*score)) %>%\n  fmt_integer(columns = votes, locale = \"fr\") %>%\n  fmt_percent(columns = score) %>%\n  gt_plt_bar_pct(\n    column = score2, scaled = TRUE\n  ) %>%\n  cols_label(\n    votes = \"Nombre votes (total)\",\n    score = \"Score (% votes exprim√©s)\",\n    candidat = \"Candidat.e\",\n    color = \"\",\n    score2 = \"\"\n    ) %>%\n  data_color(columns = c('score'), target_columns = color, method = \"numeric\", palette = \"PuOr\") %>%\n  tab_header(\n    title = md(\"__Elections üá´üá∑__\"),\n    subtitle = md(\"R√©sultats du premier tour (üìÖ _10 avril 2022_)\")\n  ) %>%\n  tab_style(\n    style = cell_text(weight = \"bold\", align = \"center\"),\n    locations = cells_column_labels()\n  )\n```\n\n\n```{r}\n#| eval: false\n\n# Calculer pour les d√©partements de la petite couronne,\n# les scores de E. Macron, M. Le Pen. agr√©ger les votes restants en autre\nvotes_idf_top3 <- df %>%\n  filter(!is.na(prenom)) %>%\n  filter(code_departement %in% c(75,92,93,94)) %>%\n  mutate(candidat2 = if_else(\n    nom %in% c(\"MACRON\", \"LE PEN\"),\n    candidat, \"Autres candidats\")) %>%\n  group_by(code_departement, candidat2) %>%\n  summarise(votes = sum(voix)) %>%\n  group_by(code_departement) %>% \n  mutate(score = votes/sum(votes))\n\nvotes_idf_top3 <- votes_idf_top3 %>%\n  group_by(code_departement) %>%\n  summarize(list_data = list(score))\n\ngt(votes_idf_top3) %>%\n  gt_plt_bar_stack(list_data, width = 65,\n                   labels = c(\"Autres candidats\", \"Macron\", \"Le Pen\"),\n                   palette= c(\"#bfbfbf\", \"#ff4343\", \"#0a1c2b\"))\n```\n\n## Comparaison des scores d√©partements aux moyennes nationales. \n\nOn va essayer d'√©tudier la territorialit√© de certains votes. Pour cela, nous\nallons √©tudier la mani√®re dont certains candidats sont surrepr√©sent√©s dans\nles r√©sultats par rapport √† leur moyenne nationale. \n\n\n::: {.callout-tip}\n## Question 4\n\nCr√©er un _dataframe_ nomm√© `score_departements` stockant, pour chaque\nd√©partement, le nombre de vote obtenu pour chaque candidat et \nle score (en %). \n\n```{r}\nscore_departements <- df %>%\n  filter(!is.na(prenom)) %>%\n  group_by(code_departement, candidat) %>%\n  summarise(votes = sum(voix)) %>%\n  mutate(score = votes/sum(votes)) \n```\n\nPar exemple, vous devriez obtenir le r√©sultat suivant pour l'Aude:\n\n\n```{r}\n#| output: true\nscore_departements %>% filter(code_departement == 11)\n```\n\n:::\n\n\n::: {.callout-tip}\n## Question 5\n\nRefaire le lien avec le niveau national pour comparer le score\nd√©partemental avec le score national. Nommer ce _dataframe_\n`score_departements`, nous allons le r√©utiliser par la suite. \n\n```{r}\nscore_departements <- score_departements %>%\n  left_join(\n    tableau_resultats,\n    by = \"candidat\",\n    suffix = c(\"_departement\", \"_national\")\n  )\n```\n\nPar exemple, vous devriez obtenir le r√©sultat suivant pour l'Aude:\n\n\n```{r}\n#| output: true\nscore_departements %>% filter(code_departement == 11)\n```\n\n:::\n\n\n::: {.callout-tip}\n## Question 6\n\nCr√©er une variable `surrepresentation` qui compare, en relatif, \nles scores nationaux et d√©partementaux.\n\nPar exemple, si un candidat a un score de 30% dans un d√©partement\nmais de 15% ailleurs, la valeur de `surrepresentation` sera √©gale √† 100 (%).\n\n\n```{r}\nscore_departements <- score_departements %>%\n  mutate(surrepresentation = 100*(score_departement/score_national - 1))\n```\n\n:::\n\n::: {.callout-tip}\n## Question 7\n\nObserver les 5 principales repr√©sentations, en valeur absolue,\npour chaque candidat. Repr√©senter cela sur un graphique, \ndu type de celui-ci dessous.\n\n```{r}\n#| output: true\nscore_departements_top <- score_departements %>%\n  arrange(candidat, desc(abs(surrepresentation))) %>%\n  group_by(candidat) %>%\n  filter(row_number() <= 5)\n\nggplot(score_departements_top) +\n  geom_bar(aes(x = surrepresentation, y = factor(code_departement)), stat = \"identity\") +\n  facet_wrap(~candidat, scales = \"free\")\n```\n\n:::\n\n\n## Un peu de cartographie\n\nPour cette partie, vous pouvez r√©cup√©rer le fond de carte\ndes d√©partements gr√¢ce au code ci-dessous:\n\n```{r}\n#| echo: true\ndepartement_borders <- download_vectorfile_url_all(\n  crs = 4326,\n  values = \"metropole\",\n  borders=\"DEPARTEMENT\",\n  vectorfile_format=\"geojson\",\n  filter_by=\"FRANCE_ENTIERE\",\n  source=\"EXPRESS-COG-CARTO-TERRITOIRE\",\n  year=2022)\n```\n\n\n::: {.callout-tip}\n## Question 8a\n\nRestreindre `score_departements` aux r√©sultats de Marine Le Pen (ne pas √©craser\n`score_departements` nous allons l'utiliser √† nouveau !). Faire une jointure\nau fond de carte des d√©partements et effectuer une carte de la repr√©sentation. \nL'√©chelle de couleur que vous pouvez utiliser est `white` pour les valeurs les\nplus basses et `#394679` pour les valeurs les plus hautes.\n\nInterpr√©ter.\n\n:::\n\n```{r}\nscore_departements_mlp <- score_departements %>%\n  filter(candidat == \"Marine LE PEN\")\n\ndepartement_borders_mlp <- departement_borders %>%\n  left_join(score_departements_mlp, by = c(\"INSEE_DEP\" = \"code_departement\"))\n```\n\n\nVous devriez obtenir une carte proche de celle-ci\n\n```{r}\n#| output: true\nggplot(departement_borders_mlp) +\n  geom_sf(aes(fill = surrepresentation)) +\n  scale_fill_steps(\n    n.breaks = 5,\n    low = \"white\", high = \"#394679\",\n    labels = label_number(scale_cut = cut_short_scale())\n  ) +\n  theme_void()  +\n  labs(fill = \"(% par rapport\\nmoyenne nationale)\")\n```\n\n\n\n::: {.callout-tip}\n## Question 8b\n\nM√™me question pour Emmanuel Macron. \nL'√©chelle de couleur que vous pouvez utiliser est `white` pour les valeurs les\nplus basses et `#f1c237` pour les valeurs les plus hautes.\n\nInterpr√©ter.\n\n:::\n\n\n```{r}\nscore_departements_em <- score_departements %>%\n  filter(candidat == \"Emmanuel MACRON\")\n\ndepartement_borders_em <- departement_borders %>%\n  left_join(score_departements_em, by = c(\"INSEE_DEP\" = \"code_departement\"))\n```\n\n```{r}\n#| output: true\nggplot(departement_borders_em) +\n  geom_sf(aes(fill = surrepresentation)) +\n  scale_fill_steps(\n    n.breaks = 5,\n    low = \"white\", high = \"#f1c237\",\n    labels = label_number(scale_cut = cut_short_scale())\n  ) +\n  theme_void()  +\n  labs(fill = \"(% par rapport\\nmoyenne nationale)\")\n```\n\n::: {.callout-tip}\n## Question 8c\n\nM√™me question pour Jean-Luc M√©lenchon. \nL'√©chelle de couleur que vous pouvez utiliser est `white` pour les valeurs les\nplus basses et `#cb452a` pour les valeurs les plus hautes.\n\nInterpr√©ter.\n\n:::\n\n\n```{r}\nscore_departements_jlm <- score_departements %>%\n  filter(candidat == \"Jean-Luc M√âLENCHON\")\n\ndepartement_borders_jlm <- departement_borders %>%\n  left_join(score_departements_jlm, by = c(\"INSEE_DEP\" = \"code_departement\"))\n```\n\n```{r}\n#| output: true\nggplot(departement_borders_jlm) +\n  geom_sf(aes(fill = surrepresentation)) +\n  scale_fill_steps(\n    n.breaks = 5,\n    low = \"white\", high = \"#cb452a\",\n    labels = label_number(scale_cut = cut_short_scale())\n  ) +\n  theme_void()  +\n  labs(fill = \"(% par rapport\\nmoyenne nationale)\")\n```\n\n\n## Focus sur l'abstention\n\n::: {.callout-tip}\n# Question 9\n\nRetrouver les 10 principales communes abstentionnistes parmi les \ncommunes o√π il y a eu plus de 2000 votes et n'appartenant pas\naux d√©partements des DROM ou des Fran√ßais √† l'√©tranger\n(pour cela, le filtre est\ndirectement donn√©: `filter(!str_starts(code_commune, \"(fr|98|97)\"))`.\n\nAnalyser\n\n:::\n\n\n```{r}\nabstention <- df %>%\n  mutate(abstention = if_else(nom == \"abstentions\", \"Abstentions\", \"Exprim√©s\")) %>%\n  group_by(code_commune, libelle_commune, abstention) %>%\n  summarise(votes = sum(voix)) %>%\n  group_by(code_commune, libelle_commune) %>%\n  mutate(taux_abstention = votes/sum(votes)) %>%\n  filter(\n    abstention == \"Abstentions\", !str_starts(code_commune, \"(fr|98|97)\"),\n    votes > 2000\n    ) %>%\n  arrange(desc(taux_abstention))\n```\n\n\nLe tableau √† obtenir sera le suivant. Le votre devra avoir au moins une colonne\nsuppl√©mentaire: les noms de commune. \n\n```{r}\n#| output: true\nabstention %>%\n    select(-one_of(\"libelle_commune\"))\n```\n\n\n\n### L'abstention en Corse\n\nVoici le code pour r√©cup√©rer le fond de carte des communes Corse.\n\n\n```{r}\n#| echo: true\ncorse <- download_vectorfile_url_all(\n  crs = 4326,\n  values = c(\"2A\",\"2B\"),\n  borders=\"COMMUNE\",\n  vectorfile_format=\"geojson\",\n  filter_by=\"DEPARTEMENT\",\n  source=\"EXPRESS-COG-CARTO-TERRITOIRE\",\n  year=2022)\n```\n\n::: {.callout-note}\n\nFaire une carte du taux d'abstention par commune en Corse. Vous\npouvez la faire figer avec ggplot ou mapsf ou, si vous pr√©f√©rez,\nr√©active avec leaflet.\n:::\n\n\n\n```{r}\nabstention_corse <- df %>%\n  mutate(abstention = if_else(nom == \"abstentions\", \"Abstentions\", \"Exprim√©s\")) %>%\n  group_by(code_commune, libelle_commune, abstention) %>%\n  summarise(votes = sum(voix)) %>%\n  group_by(code_commune, libelle_commune) %>%\n  mutate(taux_abstention = votes/sum(votes)) %>%\n  filter(str_starts(code_commune,'(2A|2B)'), abstention == \"Abstentions\") %>%\n  mutate(code_commune_propre = str_sub(code_commune, 3, -1))\n\n\ncorse_enrichie <- corse %>% inner_join(abstention_corse, by = c(\"INSEE_COM\" = \"code_commune\"))\n```\n\nLa carte obtenue devrait ressembler √† celle-ci:\n\n\n```{r}\n#| output: true\nggplot(corse_enrichie) +\n  geom_sf(aes(fill = taux_abstention)) +\n  scale_fill_fermenter(\n    n.breaks = 5,\n    palette = \"RdPu\",\n    direction = 1,\n    labels = label_number(scale_cut = cut_short_scale())\n  ) +\n  theme_void() +\n  labs(fill = \"Taux d'abstention\")\n```\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":false,"output":false,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":true,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../styles.css"],"toc":true,"output-file":"eval.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.8.27","author":"Lino Galiana","theme":"cosmo","code-annotations":"hover","title":"Evaluation"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}