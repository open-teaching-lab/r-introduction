{"title":"Produire des cartes avec {{< fa brands r-project >}}","markdown":{"yaml":{"title":"Produire des cartes avec {{< fa brands r-project >}}","echo":true,"number-sections":true,"bibliography":"../references.bib"},"headingText":"Données","containsRefs":false,"markdown":"\n\n::: {.badge}\n<a href=\"https://datalab.sspcloud.fr/launcher/ide/rstudio?version=1.15.13&networking.user.enabled=true&onyxia.friendlyName=%C2%ABrstudio-cours-ENS%C2%BB»&networking.user.enabled=true&onyxia.friendlyName=«rstudio-cours-ENS»\" target=\"_blank\" rel=\"noopener\"><img src=\"https://img.shields.io/badge/Tester%20via%20SSP%20cloud%20-%20SSPCloud?logo=R&labelColor=black&color=%231965b8\" alt=\"Onyxia\"></a><br>\n:::\n\n<details>\n<summary>\nDérouler les _slides_ ci-dessous ou [cliquer ici](/slides/ggplot.qmd)\npour afficher les slides en plein écran.\n</summary>\n\n\n``` {.yaml code-preview=\"/slides/ggplot.qmd\"}\n```\n\n</details>\n\n\nDans ce TP,\nnous allons apprendre à créer des cartes\navec {{< fa brands r-project >}}. A mesure que {{< fa brands r-project >}}\ndevient incontournable auprès des personnes manipulant des données\nspatiales, les solutions pour produire des cartes \nde qualité deviennent de plus en \nplus nombreuses. {{< fa brands r-project >}} a de moins en moins à envier\naux logiciels spécialisés comme QGIS. \n\nSi vous êtes intéressés par `Python` {{< fa brands python >}},\nune version très proche de ce TP est disponible dans [mon cours de l'ENSAE](https://pythonds.linogaliana.fr/content/visualisation/maps.html).\n\n\n<!----\nLa pratique de la cartographie se fera, dans la continuité du chapitre\nsur les graphiques, en répliquant des cartes qu'on peut trouver sur\nla page de l'*open-data* de la ville de Paris \n[ici](https://opendata.paris.fr/explore/dataset/comptage-velo-donnees-compteurs/dataviz/?disjunctive.id_compteur&disjunctive.nom_compteur&disjunctive.id&disjunctive.name).\n------>\n\n::: {.callout-note}\nProduire de belles cartes demande du temps mais aussi du bon sens. \nComme toute représentation graphique, il est important de réfléchir au message\nà faire passer et aux moyens appropriés.\nLa sémiologie cartographique, \nune discipline scientifique qui s'intéresse aux messages transmis par les cartes,\npropose certaines règles pour éviter de transmettre des messages faussés,\nvolontairement ou involontairement. \n\nCertaines peuvent être retrouvées à travers des conseils pratiques\ndans\nce [guide de sémiologie cartographique](https://www.insee.fr/fr/statistiques/3640429)\nde l'Insee. Celles-ci sont reprises\ndans [ce guide](https://juliedjidji.github.io/memocarto/semio.html).\n\n[Cette présentation](https://neocarto.github.io/docs/slides/ENTPE/docs/#/title-slide)\nde Nicolas Lambert présente, à partir de nombreux exemples, quelques principes\nde la _dataviz_ cartographique.\n\n:::\n\n\nCe TP vise à initier:\n\n* A l'utilisation de `ggplot` pour la cartographie ;\n* Au _package_ [`mapsf`](https://riatelab.github.io/mapsf/),\nconçu par les géographiques du RIATE (Paris 7), le _package_ de référence\npour réaliser des cartes avec {{< fa brands r-project >}}\n* Au package [`leaflet`](https://rstudio.github.io/leaflet/) qui est un point d'accès vers la librairie `JavaScript` [`leaflet`](https://leafletjs.com/) permettant de produire des cartes interactives. Nous approfondirons ultérieurement\nles cartes réactives avec un chapitre d'ouverture vers [`Observable`](https://observablehq.com).\n\nDans ce chapitre, nous allons utiliser les _packages_ suivants:\n\n```{r}\n#| output: false\n#| echo: true\nlibrary(dplyr)\nlibrary(sf)\nlibrary(stringr)\nlibrary(archive)\nlibrary(ggplot2)\nlibrary(glue)\nlibrary(ggtext)\nlibrary(scales)\nlibrary(units)\nlibrary(leaflet)\nlibrary(cartiflette)\n```\n\n\nAu cours de ce chapitre, nous allons utiliser\nplusieurs jeux de données pour illustrer\ndifférents types de cartes:\n\n- Des comptages de population ;\n- Les limites départementales de la France métropolitaine ;\n- Les limites communales du Finistère ;\n- Le couvert forestier du département des Landes ;\n\n\n## Import des données\n\nCe TD va proposer un certain nombre de jeux de données intéressants\npour la cartographie. Comme l'import de ceux-ci n'est pas le coeur\ndu chapitre, nous proposons directement le code d'import\ndes données. \n\n\n### Populations légales au niveau départemental\n\n```{r}\n#| echo: true\n#| output: false\nlibrary(readr)\nlibrary(dplyr)\n\n# download et unzip pour avoir les fichiers\nurl_pop_legales = \"https://www.insee.fr/fr/statistiques/fichier/6683035/ensemble.zip\"\ndownload.file(url_pop_legales, \"pop_legales.zip\")\nunzip(\"pop_legales.zip\")\n\npop_legales_departements = read_csv2(\"donnees_departements.csv\")\npop_legales_finistere = read_csv2(\"donnees_communes.csv\") %>%\n  filter(CODDEP == \"29\") %>%\n  mutate(code_insee = paste0(CODDEP, CODCOM))\n```\n\n\n### Limites communales et départementales\n\nNous allons utiliser `cartiflette` qui facilite\nla récupération des fonds de carte administratifs\nde l'IGN.\n\n\n```{r}\n#| eval: false\nremotes::install_github(\"linogaliana/cartiflette-r\")\n```\n\nEn premier lieu, nous allons récupérer les limites \ndes départements:\n\n```{r}\n#| echo: true\n#| output: false\n\nlibrary(cartiflette)\ndepartement_borders <- download_vectorfile_url_all(\n    crs = 4326,\n    values = \"metropole\",\n    borders=\"DEPARTEMENT\",\n    vectorfile_format=\"geojson\",\n    filter_by=\"FRANCE_ENTIERE\",\n    source=\"EXPRESS-COG-CARTO-TERRITOIRE\",\n    year=2022)\n```\n\nPour s'en assurer, une carte peut rapidement être\nproduite:\n\n```{r}\n#| echo: true\nggplot(departement_borders) +\n  geom_sf(fill = \"transparent\") +\n  theme_void()\n```\n\nOn va également récupérer les limites des\ncommunes du Finistère avec `cartiflette`. \nVoici le code pour ne garder que les communes du Finistère (département 29):\n\n```{r}\n#| label: download-shapefile-communes\n#| echo: true\n#| output: false\n\nfinistere <- download_vectorfile_url_all(\n    crs = 4326,\n    values = \"29\",\n    borders=\"COMMUNE\",\n    vectorfile_format=\"geojson\",\n    filter_by=\"DEPARTEMENT\",\n    source=\"EXPRESS-COG-CARTO-TERRITOIRE\",\n    year=2022)\n\n\nfinistere <- finistere %>% left_join(pop_legales_finistere, by = c(\"INSEE_COM\" = \"code_insee\") )\n```\n\n\n::: {.callout-tip}\n## Exercice 1: représenter rapidement les frontières pour se placer dans l'espace\n\nOn va d'abord faire une carte simple, avec `ggplot`, des limites communales\n\n1. En s'inspirant du code précédent, faire la carte du Finistère\n\nPour en apprendre un peu plus sur les données, on va mettre en oeuvre\nune carte avec le _package_ `leaflet`. Celui-ci permettra de créer des \nvisualisations réactives, plus propices à l'exploration de données.\n\n2. Représenter les limites communales du Finistère avec le package leaflet\nen utilisant les fonctions suivantes:\n    + Afficher un fonds de carte _Open Street Map_ avec la fonction `addTiles`\n    + Afficher les limites des polygones avec la fonction `addPolylines`\n    \n3. Travailler un peu la couche `Polylines` en réduisant la taille des bordures\net en utilisant le paramètre `popup` pour afficher le nom de la ville et la\npopulation communales\n\n:::\n\nCarte obtenue à la question 1\n\n```{r}\n#| code-fold: true\n#| code-summary: \"Solution question 1\"\nggplot(finistere) +\n  geom_sf(fill = \"transparent\") +\n  theme_void()\n```\n\nCarte obtenue à la question 2\n\n```{r}\n#| code-fold: true\n#| code-summary: \"Solution question 2\"\nleaflet(finistere) %>% \n  addTiles() %>%\n  addPolylines()\n```\n\nCarte obtenue à la question 3\n\n```{r}\n#| code-fold: true\n#| code-summary: \"Solution question 3\"\nleaflet(finistere) %>% \n  addTiles() %>%\n  addPolylines(\n    weight = 2,\n    popup = ~paste0(NOM, \": \", PTOT, \" habitants\")\n  )\n```\n\n\nLes exemples de code ci-dessus illustraient une situation\noù on ne désire représenter que les limites des polygones\ndans l'objet `sf`. C'est une carte utile pour rapidement placer\nson jeu de données dans l'espace mais ça n'apporte pas \nd'information supplémentaire. Pour cela, il va être nécessaire\nd'utiliser les données tabulaires associées à la dimension spatiale.\n\n## Une carte de couverture forestière\n\nPour cette partie, nous allons faire une carte du couvert forestier\nlandais à partir de la BD Forêt produite par l'IGN. Cette dernière étant\nun petit peu volumineuse dans le format _shapefile_, nous proposons\nde la récupérer dans un format plus compressé: le _geopackage_.\n\nLe code suivant peut être utilisé pour cela:\n\n```{r}\n#| echo: true\n#| label: download-landes\nforet <- sf::st_read(\n  \"https://minio.lab.sspcloud.fr/projet-formation/diffusion/r-geographie/landes.gpkg\"\n)\n```\n\n::: {.callout-tip}\n\n1. Créer une carte du couvert forestier des Landes à partir des données\nimportées précédemment depuis la BD Forêt\n\n:::\n\n```{r}\n#| code-summary: Question 1\n#| code-fold: true\nggplot(foret) + geom_sf(fill = \"forestgreen\", lwd = 0) +\n  geom_sf(\n    data = departement_borders %>% filter(INSEE_DEP == 40) %>% st_transform(2154),\n    color = \"black\", lwd = 1, fill = \"transparent\") +\n  theme_void() +\n  labs(title = \"Couvert forestier dans les Landes\")\n```\n\n## Découverte des cartes choroplèthes\n\nLa carte par aplat de couleur, dite carte choroplèthes,\nest l'une des représentations de données géographiques\nles plus traditionnelles. \n\nD'après @chen2008brief, la première représentation de ce type \na été proposée par Charles Dupin en 1926\npour représenter les niveaux d'instruction sur le territoire français. \nL'émergence des cartes choroplèthes est en effet indissociable \nde l'organisation du pouvoir sous forme d'entités pensées\npolitiques supposées unitaires:\nles cartes du monde représentent souvent des aplats de couleurs à partir\ndes nations, les cartes nationales à partir d'échelons administratifs\n(régions, départements, communes, mais aussi Etats ou _landers_). \n\n![La première carte choroplèthes par Dupin (1826)](https://upload.wikimedia.org/wikipedia/commons/thumb/3/38/Carte_figurative_de_l%27instruction_populaire_de_la_France.jpg/800px-Carte_figurative_de_l%27instruction_populaire_de_la_France.jpg){width=\"60%\" fig-align=\"center\"}.\n\nOn peut voir l'émergence pendant le XIXe siècle de la\ncarte choroplèthe comme un moment important de la cartographie,\nun glissement de l'usage militaire vers l'usage politique.\nIl ne s'agissait plus exclusivement\nde représenter le territoire physique mais aussi la réalité socioéconomique,\ndans des bornes administratives connues de tous. \n\nMalgré toutes ces limites, sur lesquelles nous reviendrons, la carte\nchoroplèthe est tout de même instructive. Savoir en produire une rapidement,\npour saisir les principaux faits structurants d'un jeu de données, est\nparticulièrement utile. \n\n::: {.callout-tip}\n\n## Exercice 3: une première carte de la population\n\nL'objectif de cet exercice va être d'enrichir\nles informations présentées sur la carte\ndes départements.\n\n1. Utiliser le code ci-dessous\npour enrichir notre objet `sf` des départements d'une variable\nde population:\n\n```{r}\n#| echo: true\npopulation_dep <- departement_borders %>%\n  left_join(pop_legales_departements, by = c(\"INSEE_DEP\" = \"CODDEP\"))\n  \npopulation_dep <- population_dep %>%\n  mutate(densite = as.numeric(PTOT / set_units(st_area(.), \"km2\") )) %>%\n  mutate(pop_4 = cut(PTOT/1000, breaks = 4)) %>%\n  mutate(pop = PTOT)\n\nhead(population_dep, 3)\n```\n\n2. En utilisant votre connaissance de `ggplot` et\nle modèle ci-dessous, représenter\nune première carte par aplat de couleur ([_choropleth map_](https://en.wikipedia.org/wiki/Choropleth_map)) de la variable `pop`\n\n```{r}\n#| output: false\n#| echo: true\n# Modèle\nggplot(departement_borders) + geom_sf(fill = \"white\") + theme_void()\n```\n\nCette carte étant peu lisible, on propose, en premier lieu,\nde discrétiser ses couleurs.\n\n3. Utiliser la variable `pop_4` pour voir un petit peu à quoi ressemble\nune version discrétisée de notre carte de population. \n\nCela apparaît mieux mais la discrétisation n'est sans doute pas idéale,\nles catégories étant plutôt hasardeuses. Il vaut mieux\nutiliser `scale_fill_steps` qui construit de manière plus pertinente les \ncatégories de couleurs. \n\n4. Reprendre la carte de la question 2 construite avec la variable continue\n`pop`. Appliquer l'échelle de couleur de `scale_fill_steps`\n\n5. Il existe aussi la fonction `scale_fill_fermenter` qui permet de discrétiser\nune échelle continue. A partir de la palette `RdPu`, construire une \ncarte discrétisée. \n\n6. Choisir une des deux approches et travailler cette carte pour la rendre\nplus esthétique. Par exemple, avec `scale_fill_steps`, travailler\nla carte pour la faire ressembler à la chloroplèthe de Dupin. \n[Ce site](https://colorbrewer2.org/#type=sequential&scheme=Blues&n=3) est \npratique pour explorer les palettes de couleurs. \n:::\n\n```{r}\n#| label: q2-exo1\n# Question 2\nplot_q2_exo1 <- ggplot(population_dep) + geom_sf(aes(fill = pop)) + theme_void()\n```\n\n```{r}\n#| label: q3-exo1\n# Question 3\nplot_q3_exo1 <- ggplot(population_dep) + geom_sf(aes(fill = pop_4)) + theme_void()\n```\n\n```{r}\n# Question 4\nplot_q4_exo1 <- ggplot(\n  population_dep\n) + geom_sf(aes(fill = pop)) +\n  scale_fill_steps() +\n  theme_void()\n```\n\n```{r}\n# Question 5\nplot_q5_exo1 <- ggplot(\n  population_dep\n) + geom_sf(aes(fill = pop)) +\n  scale_fill_fermenter(\n    n.breaks = 5,\n    palette = \"RdPu\",\n    direction = 1,\n    labels = label_number(scale_cut = cut_short_scale())\n    ) +\n  theme_void()\n```\n\n\n```{r}\n#| label: q6-exo1\n# Question 6\nplot_q6_exo1 <- ggplot(\n    population_dep\n) + geom_sf(aes(fill = pop), color = \"white\") +\n    scale_fill_steps(\n        n.breaks = 5, trans = \"log\",\n        low = \"white\", high = \"black\",\n        labels = label_number(scale_cut = cut_short_scale())\n    ) +\n    theme_void() +\n  labs(fill = \"Population\")\n\nplot_q6_exo1_bis <- ggplot(\n    population_dep\n) + geom_sf(aes(fill = densite), color = \"white\") +\n    scale_fill_steps(\n        n.breaks = 5, trans = \"log\",\n        low = \"white\", high = \"black\",\n        labels = label_number(scale_cut = cut_short_scale())\n    ) +\n    theme_void() +\n  labs(fill = \"Habitants\\n(par km²)\")\n```\n\n\n<details>\n<summary>\nCarte obtenue à la question 2\n</summary>\n```{r}\n#| echo: false\nplot_q2_exo1\n```\n</details>\n\n\n<details>\n<summary>\nCarte obtenue à la question 3\n</summary>\n```{r}\n#| echo: false\nplot_q3_exo1\n```\n</details>\n\n<details>\n<summary>\nCarte obtenue à la question 4\n</summary>\n```{r}\n#| echo: false\nplot_q4_exo1\n```\n</details>\n\n\n<details>\n<summary>\nCarte obtenue à la question 5\n</summary>\n```{r}\n#| echo: false\nplot_q5_exo1\n```\n</details>\n\n\n<details>\n<summary>\nCartes obtenue à la question 6\n</summary>\n\n```{r}\n#| echo: false\nplot_q6_exo1\n```\n\n```{r}\n#| echo: false\nplot_q6_exo1_bis\n```\n\n\n</details>\n\nAvec `ggplot2`, avec peu de travail sur le style,\non obtient déjà une carte déjà intéressante. On voit bien dessus\nla _\"diagonale du vide\"_. Par exemple, les deux cartes dans le style de \nDupin (1826):\n\n```{r}\n#| echo: false\n#| layout-ncol: 2\n#| fig-cap: \n#|   - \"Carte de la population française\"\n#|   - \"Carte de densité de la population française\"\nplot_q6_exo1\n\nplot_q6_exo1_bis\n```\n\nLa carte de densité est plus représentative de la réalité démographique\nque la carte ne tenant pas compte des surfaces. Néanmoins elle reste \nimparfaite pour décrire la très forte concentration de la population dans l'aire\nparisienne. Pour mieux représenter les phénomènes en présence de zonages\nde dimension hétérogène, il sera nécessaire d'utiliser une autre représentation\ncartographique, comme les ronds proportionnels ou les cartogrammes. \n\n::: {.callout-tip}\n\n## Exercice supplémentaire: déplacer les DROM, zoomer sur l'Île de France\n\nUn exercice illustratif à venir\n:::\n\n\n## D'autres cartes avec `mapsf`\n\nEn soi, il est possible de faire des cartes autres que les aplats de couleurs\navec `ggplot`. Néanmoins, c'est un peu complexe à mettre en oeuvre pour\ncontrôler de manière fine l'étendue des cercles. Heureusement, il existe\nun package adapté pour cela, construit par des géographes \npour des géographes: le _package_ `mapsf` !\n\nL'exercice suivant va illustrer comment créer ce type de carte. \n\n::: {.callout-tip}\n\n## Exercice 4: représentations alternatives avec `mapsf`\n\n1. Recréer une carte choroplèthe avec `mapsf` en utilisant \n4 couleurs dont les valeurs proviennent des quantiles de la \ndistribution des densités\n\n2. Pour se rendre compte de la nature hautement non-linéaire de notre\nvariable de densité, représenter la même carte avec l'argument `breaks` égal\nà `equal` ou `pretty`.\n\n3. Pour s'abstraire du problème de biais visuel lié aux chrolepthes, \non peut tester la représentation par ronds proportionnels. Représenter la\nmême information mais en utilisant cette fois des ronds proportionnels. \n\n4. [Cette page](https://transcarto.github.io/rcartograms/TRANSCARTO_cartograms.html)\npropose de nombreuses représentations de données. Reproduire la figure ci-dessous\navec notre jeu de données du Finistère\n\n![](isere_bronner_bertin.png){fig-width=\"60%\"}\n\n:::\n\n```{r}\n# code-fold: true\n# code-summary: Question 1\nlibrary(mapsf)\nmf_map(\n  population_dep, var = \"densite\", type = \"choro\", nbreaks = 4,\n  pal = \"Dark Mint\",\n  leg_val_rnd = -2,\n  breaks = \"arith\")\n```\n\n```{r}\n# code-fold: true\n# code-summary: Question 2\nmf_map(\n  population_dep, var = \"densite\", type = \"choro\", nbreaks = 4,\n  pal = \"Dark Mint\",\n  leg_val_rnd = -2,\n  breaks = \"quantile\")\n```\n\n```{r}\n# code-fold: true\n# code-summary: Question 3\npopulation_dep_lambert <- population_dep %>% st_transform(2154)\nmf_map(population_dep_lambert)\nmf_map(population_dep_lambert, var = \"densite\", type = \"prop\")\nmf_layout(\n    title = \"Densité en France\"\n)\n```\n\n\n```{r}\n# code-fold: true\n# code-summary: Question 4\nfinistere <- finistere %>% st_transform(2154)\n\nmf_map(\n  finistere,\n  col = \"#CCCCCC\",\n  border = \"white\",\n  lwd = 0.5\n)\nmf_map(\n  finistere, var = \"PTOT\",\n  type = \"prop\",\n  col = \"#c291bc\",\n  border = \"#6b4266\",\n  lwd = 0.5,\n  add = TRUE\n)\nmf_title(\"Population du Finistère\", bg = \"#6b4266\")\nmf_annotation(\n      x = c(132040, 6826675),\n      txt = \"Finistère (29)\",\n      pos = \"bottomleft\",\n      col_txt = \"#6b4266\",\n      cex = 1.2,\n      font = 2,\n      halo = TRUE,\n      s = 1.5\n    )\n```\n\n\n","srcMarkdownNoYaml":"\n\n::: {.badge}\n<a href=\"https://datalab.sspcloud.fr/launcher/ide/rstudio?version=1.15.13&networking.user.enabled=true&onyxia.friendlyName=%C2%ABrstudio-cours-ENS%C2%BB»&networking.user.enabled=true&onyxia.friendlyName=«rstudio-cours-ENS»\" target=\"_blank\" rel=\"noopener\"><img src=\"https://img.shields.io/badge/Tester%20via%20SSP%20cloud%20-%20SSPCloud?logo=R&labelColor=black&color=%231965b8\" alt=\"Onyxia\"></a><br>\n:::\n\n<details>\n<summary>\nDérouler les _slides_ ci-dessous ou [cliquer ici](/slides/ggplot.qmd)\npour afficher les slides en plein écran.\n</summary>\n\n\n``` {.yaml code-preview=\"/slides/ggplot.qmd\"}\n```\n\n</details>\n\n\nDans ce TP,\nnous allons apprendre à créer des cartes\navec {{< fa brands r-project >}}. A mesure que {{< fa brands r-project >}}\ndevient incontournable auprès des personnes manipulant des données\nspatiales, les solutions pour produire des cartes \nde qualité deviennent de plus en \nplus nombreuses. {{< fa brands r-project >}} a de moins en moins à envier\naux logiciels spécialisés comme QGIS. \n\nSi vous êtes intéressés par `Python` {{< fa brands python >}},\nune version très proche de ce TP est disponible dans [mon cours de l'ENSAE](https://pythonds.linogaliana.fr/content/visualisation/maps.html).\n\n\n<!----\nLa pratique de la cartographie se fera, dans la continuité du chapitre\nsur les graphiques, en répliquant des cartes qu'on peut trouver sur\nla page de l'*open-data* de la ville de Paris \n[ici](https://opendata.paris.fr/explore/dataset/comptage-velo-donnees-compteurs/dataviz/?disjunctive.id_compteur&disjunctive.nom_compteur&disjunctive.id&disjunctive.name).\n------>\n\n::: {.callout-note}\nProduire de belles cartes demande du temps mais aussi du bon sens. \nComme toute représentation graphique, il est important de réfléchir au message\nà faire passer et aux moyens appropriés.\nLa sémiologie cartographique, \nune discipline scientifique qui s'intéresse aux messages transmis par les cartes,\npropose certaines règles pour éviter de transmettre des messages faussés,\nvolontairement ou involontairement. \n\nCertaines peuvent être retrouvées à travers des conseils pratiques\ndans\nce [guide de sémiologie cartographique](https://www.insee.fr/fr/statistiques/3640429)\nde l'Insee. Celles-ci sont reprises\ndans [ce guide](https://juliedjidji.github.io/memocarto/semio.html).\n\n[Cette présentation](https://neocarto.github.io/docs/slides/ENTPE/docs/#/title-slide)\nde Nicolas Lambert présente, à partir de nombreux exemples, quelques principes\nde la _dataviz_ cartographique.\n\n:::\n\n\nCe TP vise à initier:\n\n* A l'utilisation de `ggplot` pour la cartographie ;\n* Au _package_ [`mapsf`](https://riatelab.github.io/mapsf/),\nconçu par les géographiques du RIATE (Paris 7), le _package_ de référence\npour réaliser des cartes avec {{< fa brands r-project >}}\n* Au package [`leaflet`](https://rstudio.github.io/leaflet/) qui est un point d'accès vers la librairie `JavaScript` [`leaflet`](https://leafletjs.com/) permettant de produire des cartes interactives. Nous approfondirons ultérieurement\nles cartes réactives avec un chapitre d'ouverture vers [`Observable`](https://observablehq.com).\n\nDans ce chapitre, nous allons utiliser les _packages_ suivants:\n\n```{r}\n#| output: false\n#| echo: true\nlibrary(dplyr)\nlibrary(sf)\nlibrary(stringr)\nlibrary(archive)\nlibrary(ggplot2)\nlibrary(glue)\nlibrary(ggtext)\nlibrary(scales)\nlibrary(units)\nlibrary(leaflet)\nlibrary(cartiflette)\n```\n\n## Données\n\nAu cours de ce chapitre, nous allons utiliser\nplusieurs jeux de données pour illustrer\ndifférents types de cartes:\n\n- Des comptages de population ;\n- Les limites départementales de la France métropolitaine ;\n- Les limites communales du Finistère ;\n- Le couvert forestier du département des Landes ;\n\n\n## Import des données\n\nCe TD va proposer un certain nombre de jeux de données intéressants\npour la cartographie. Comme l'import de ceux-ci n'est pas le coeur\ndu chapitre, nous proposons directement le code d'import\ndes données. \n\n\n### Populations légales au niveau départemental\n\n```{r}\n#| echo: true\n#| output: false\nlibrary(readr)\nlibrary(dplyr)\n\n# download et unzip pour avoir les fichiers\nurl_pop_legales = \"https://www.insee.fr/fr/statistiques/fichier/6683035/ensemble.zip\"\ndownload.file(url_pop_legales, \"pop_legales.zip\")\nunzip(\"pop_legales.zip\")\n\npop_legales_departements = read_csv2(\"donnees_departements.csv\")\npop_legales_finistere = read_csv2(\"donnees_communes.csv\") %>%\n  filter(CODDEP == \"29\") %>%\n  mutate(code_insee = paste0(CODDEP, CODCOM))\n```\n\n\n### Limites communales et départementales\n\nNous allons utiliser `cartiflette` qui facilite\nla récupération des fonds de carte administratifs\nde l'IGN.\n\n\n```{r}\n#| eval: false\nremotes::install_github(\"linogaliana/cartiflette-r\")\n```\n\nEn premier lieu, nous allons récupérer les limites \ndes départements:\n\n```{r}\n#| echo: true\n#| output: false\n\nlibrary(cartiflette)\ndepartement_borders <- download_vectorfile_url_all(\n    crs = 4326,\n    values = \"metropole\",\n    borders=\"DEPARTEMENT\",\n    vectorfile_format=\"geojson\",\n    filter_by=\"FRANCE_ENTIERE\",\n    source=\"EXPRESS-COG-CARTO-TERRITOIRE\",\n    year=2022)\n```\n\nPour s'en assurer, une carte peut rapidement être\nproduite:\n\n```{r}\n#| echo: true\nggplot(departement_borders) +\n  geom_sf(fill = \"transparent\") +\n  theme_void()\n```\n\nOn va également récupérer les limites des\ncommunes du Finistère avec `cartiflette`. \nVoici le code pour ne garder que les communes du Finistère (département 29):\n\n```{r}\n#| label: download-shapefile-communes\n#| echo: true\n#| output: false\n\nfinistere <- download_vectorfile_url_all(\n    crs = 4326,\n    values = \"29\",\n    borders=\"COMMUNE\",\n    vectorfile_format=\"geojson\",\n    filter_by=\"DEPARTEMENT\",\n    source=\"EXPRESS-COG-CARTO-TERRITOIRE\",\n    year=2022)\n\n\nfinistere <- finistere %>% left_join(pop_legales_finistere, by = c(\"INSEE_COM\" = \"code_insee\") )\n```\n\n\n::: {.callout-tip}\n## Exercice 1: représenter rapidement les frontières pour se placer dans l'espace\n\nOn va d'abord faire une carte simple, avec `ggplot`, des limites communales\n\n1. En s'inspirant du code précédent, faire la carte du Finistère\n\nPour en apprendre un peu plus sur les données, on va mettre en oeuvre\nune carte avec le _package_ `leaflet`. Celui-ci permettra de créer des \nvisualisations réactives, plus propices à l'exploration de données.\n\n2. Représenter les limites communales du Finistère avec le package leaflet\nen utilisant les fonctions suivantes:\n    + Afficher un fonds de carte _Open Street Map_ avec la fonction `addTiles`\n    + Afficher les limites des polygones avec la fonction `addPolylines`\n    \n3. Travailler un peu la couche `Polylines` en réduisant la taille des bordures\net en utilisant le paramètre `popup` pour afficher le nom de la ville et la\npopulation communales\n\n:::\n\nCarte obtenue à la question 1\n\n```{r}\n#| code-fold: true\n#| code-summary: \"Solution question 1\"\nggplot(finistere) +\n  geom_sf(fill = \"transparent\") +\n  theme_void()\n```\n\nCarte obtenue à la question 2\n\n```{r}\n#| code-fold: true\n#| code-summary: \"Solution question 2\"\nleaflet(finistere) %>% \n  addTiles() %>%\n  addPolylines()\n```\n\nCarte obtenue à la question 3\n\n```{r}\n#| code-fold: true\n#| code-summary: \"Solution question 3\"\nleaflet(finistere) %>% \n  addTiles() %>%\n  addPolylines(\n    weight = 2,\n    popup = ~paste0(NOM, \": \", PTOT, \" habitants\")\n  )\n```\n\n\nLes exemples de code ci-dessus illustraient une situation\noù on ne désire représenter que les limites des polygones\ndans l'objet `sf`. C'est une carte utile pour rapidement placer\nson jeu de données dans l'espace mais ça n'apporte pas \nd'information supplémentaire. Pour cela, il va être nécessaire\nd'utiliser les données tabulaires associées à la dimension spatiale.\n\n## Une carte de couverture forestière\n\nPour cette partie, nous allons faire une carte du couvert forestier\nlandais à partir de la BD Forêt produite par l'IGN. Cette dernière étant\nun petit peu volumineuse dans le format _shapefile_, nous proposons\nde la récupérer dans un format plus compressé: le _geopackage_.\n\nLe code suivant peut être utilisé pour cela:\n\n```{r}\n#| echo: true\n#| label: download-landes\nforet <- sf::st_read(\n  \"https://minio.lab.sspcloud.fr/projet-formation/diffusion/r-geographie/landes.gpkg\"\n)\n```\n\n::: {.callout-tip}\n\n1. Créer une carte du couvert forestier des Landes à partir des données\nimportées précédemment depuis la BD Forêt\n\n:::\n\n```{r}\n#| code-summary: Question 1\n#| code-fold: true\nggplot(foret) + geom_sf(fill = \"forestgreen\", lwd = 0) +\n  geom_sf(\n    data = departement_borders %>% filter(INSEE_DEP == 40) %>% st_transform(2154),\n    color = \"black\", lwd = 1, fill = \"transparent\") +\n  theme_void() +\n  labs(title = \"Couvert forestier dans les Landes\")\n```\n\n## Découverte des cartes choroplèthes\n\nLa carte par aplat de couleur, dite carte choroplèthes,\nest l'une des représentations de données géographiques\nles plus traditionnelles. \n\nD'après @chen2008brief, la première représentation de ce type \na été proposée par Charles Dupin en 1926\npour représenter les niveaux d'instruction sur le territoire français. \nL'émergence des cartes choroplèthes est en effet indissociable \nde l'organisation du pouvoir sous forme d'entités pensées\npolitiques supposées unitaires:\nles cartes du monde représentent souvent des aplats de couleurs à partir\ndes nations, les cartes nationales à partir d'échelons administratifs\n(régions, départements, communes, mais aussi Etats ou _landers_). \n\n![La première carte choroplèthes par Dupin (1826)](https://upload.wikimedia.org/wikipedia/commons/thumb/3/38/Carte_figurative_de_l%27instruction_populaire_de_la_France.jpg/800px-Carte_figurative_de_l%27instruction_populaire_de_la_France.jpg){width=\"60%\" fig-align=\"center\"}.\n\nOn peut voir l'émergence pendant le XIXe siècle de la\ncarte choroplèthe comme un moment important de la cartographie,\nun glissement de l'usage militaire vers l'usage politique.\nIl ne s'agissait plus exclusivement\nde représenter le territoire physique mais aussi la réalité socioéconomique,\ndans des bornes administratives connues de tous. \n\nMalgré toutes ces limites, sur lesquelles nous reviendrons, la carte\nchoroplèthe est tout de même instructive. Savoir en produire une rapidement,\npour saisir les principaux faits structurants d'un jeu de données, est\nparticulièrement utile. \n\n::: {.callout-tip}\n\n## Exercice 3: une première carte de la population\n\nL'objectif de cet exercice va être d'enrichir\nles informations présentées sur la carte\ndes départements.\n\n1. Utiliser le code ci-dessous\npour enrichir notre objet `sf` des départements d'une variable\nde population:\n\n```{r}\n#| echo: true\npopulation_dep <- departement_borders %>%\n  left_join(pop_legales_departements, by = c(\"INSEE_DEP\" = \"CODDEP\"))\n  \npopulation_dep <- population_dep %>%\n  mutate(densite = as.numeric(PTOT / set_units(st_area(.), \"km2\") )) %>%\n  mutate(pop_4 = cut(PTOT/1000, breaks = 4)) %>%\n  mutate(pop = PTOT)\n\nhead(population_dep, 3)\n```\n\n2. En utilisant votre connaissance de `ggplot` et\nle modèle ci-dessous, représenter\nune première carte par aplat de couleur ([_choropleth map_](https://en.wikipedia.org/wiki/Choropleth_map)) de la variable `pop`\n\n```{r}\n#| output: false\n#| echo: true\n# Modèle\nggplot(departement_borders) + geom_sf(fill = \"white\") + theme_void()\n```\n\nCette carte étant peu lisible, on propose, en premier lieu,\nde discrétiser ses couleurs.\n\n3. Utiliser la variable `pop_4` pour voir un petit peu à quoi ressemble\nune version discrétisée de notre carte de population. \n\nCela apparaît mieux mais la discrétisation n'est sans doute pas idéale,\nles catégories étant plutôt hasardeuses. Il vaut mieux\nutiliser `scale_fill_steps` qui construit de manière plus pertinente les \ncatégories de couleurs. \n\n4. Reprendre la carte de la question 2 construite avec la variable continue\n`pop`. Appliquer l'échelle de couleur de `scale_fill_steps`\n\n5. Il existe aussi la fonction `scale_fill_fermenter` qui permet de discrétiser\nune échelle continue. A partir de la palette `RdPu`, construire une \ncarte discrétisée. \n\n6. Choisir une des deux approches et travailler cette carte pour la rendre\nplus esthétique. Par exemple, avec `scale_fill_steps`, travailler\nla carte pour la faire ressembler à la chloroplèthe de Dupin. \n[Ce site](https://colorbrewer2.org/#type=sequential&scheme=Blues&n=3) est \npratique pour explorer les palettes de couleurs. \n:::\n\n```{r}\n#| label: q2-exo1\n# Question 2\nplot_q2_exo1 <- ggplot(population_dep) + geom_sf(aes(fill = pop)) + theme_void()\n```\n\n```{r}\n#| label: q3-exo1\n# Question 3\nplot_q3_exo1 <- ggplot(population_dep) + geom_sf(aes(fill = pop_4)) + theme_void()\n```\n\n```{r}\n# Question 4\nplot_q4_exo1 <- ggplot(\n  population_dep\n) + geom_sf(aes(fill = pop)) +\n  scale_fill_steps() +\n  theme_void()\n```\n\n```{r}\n# Question 5\nplot_q5_exo1 <- ggplot(\n  population_dep\n) + geom_sf(aes(fill = pop)) +\n  scale_fill_fermenter(\n    n.breaks = 5,\n    palette = \"RdPu\",\n    direction = 1,\n    labels = label_number(scale_cut = cut_short_scale())\n    ) +\n  theme_void()\n```\n\n\n```{r}\n#| label: q6-exo1\n# Question 6\nplot_q6_exo1 <- ggplot(\n    population_dep\n) + geom_sf(aes(fill = pop), color = \"white\") +\n    scale_fill_steps(\n        n.breaks = 5, trans = \"log\",\n        low = \"white\", high = \"black\",\n        labels = label_number(scale_cut = cut_short_scale())\n    ) +\n    theme_void() +\n  labs(fill = \"Population\")\n\nplot_q6_exo1_bis <- ggplot(\n    population_dep\n) + geom_sf(aes(fill = densite), color = \"white\") +\n    scale_fill_steps(\n        n.breaks = 5, trans = \"log\",\n        low = \"white\", high = \"black\",\n        labels = label_number(scale_cut = cut_short_scale())\n    ) +\n    theme_void() +\n  labs(fill = \"Habitants\\n(par km²)\")\n```\n\n\n<details>\n<summary>\nCarte obtenue à la question 2\n</summary>\n```{r}\n#| echo: false\nplot_q2_exo1\n```\n</details>\n\n\n<details>\n<summary>\nCarte obtenue à la question 3\n</summary>\n```{r}\n#| echo: false\nplot_q3_exo1\n```\n</details>\n\n<details>\n<summary>\nCarte obtenue à la question 4\n</summary>\n```{r}\n#| echo: false\nplot_q4_exo1\n```\n</details>\n\n\n<details>\n<summary>\nCarte obtenue à la question 5\n</summary>\n```{r}\n#| echo: false\nplot_q5_exo1\n```\n</details>\n\n\n<details>\n<summary>\nCartes obtenue à la question 6\n</summary>\n\n```{r}\n#| echo: false\nplot_q6_exo1\n```\n\n```{r}\n#| echo: false\nplot_q6_exo1_bis\n```\n\n\n</details>\n\nAvec `ggplot2`, avec peu de travail sur le style,\non obtient déjà une carte déjà intéressante. On voit bien dessus\nla _\"diagonale du vide\"_. Par exemple, les deux cartes dans le style de \nDupin (1826):\n\n```{r}\n#| echo: false\n#| layout-ncol: 2\n#| fig-cap: \n#|   - \"Carte de la population française\"\n#|   - \"Carte de densité de la population française\"\nplot_q6_exo1\n\nplot_q6_exo1_bis\n```\n\nLa carte de densité est plus représentative de la réalité démographique\nque la carte ne tenant pas compte des surfaces. Néanmoins elle reste \nimparfaite pour décrire la très forte concentration de la population dans l'aire\nparisienne. Pour mieux représenter les phénomènes en présence de zonages\nde dimension hétérogène, il sera nécessaire d'utiliser une autre représentation\ncartographique, comme les ronds proportionnels ou les cartogrammes. \n\n::: {.callout-tip}\n\n## Exercice supplémentaire: déplacer les DROM, zoomer sur l'Île de France\n\nUn exercice illustratif à venir\n:::\n\n\n## D'autres cartes avec `mapsf`\n\nEn soi, il est possible de faire des cartes autres que les aplats de couleurs\navec `ggplot`. Néanmoins, c'est un peu complexe à mettre en oeuvre pour\ncontrôler de manière fine l'étendue des cercles. Heureusement, il existe\nun package adapté pour cela, construit par des géographes \npour des géographes: le _package_ `mapsf` !\n\nL'exercice suivant va illustrer comment créer ce type de carte. \n\n::: {.callout-tip}\n\n## Exercice 4: représentations alternatives avec `mapsf`\n\n1. Recréer une carte choroplèthe avec `mapsf` en utilisant \n4 couleurs dont les valeurs proviennent des quantiles de la \ndistribution des densités\n\n2. Pour se rendre compte de la nature hautement non-linéaire de notre\nvariable de densité, représenter la même carte avec l'argument `breaks` égal\nà `equal` ou `pretty`.\n\n3. Pour s'abstraire du problème de biais visuel lié aux chrolepthes, \non peut tester la représentation par ronds proportionnels. Représenter la\nmême information mais en utilisant cette fois des ronds proportionnels. \n\n4. [Cette page](https://transcarto.github.io/rcartograms/TRANSCARTO_cartograms.html)\npropose de nombreuses représentations de données. Reproduire la figure ci-dessous\navec notre jeu de données du Finistère\n\n![](isere_bronner_bertin.png){fig-width=\"60%\"}\n\n:::\n\n```{r}\n# code-fold: true\n# code-summary: Question 1\nlibrary(mapsf)\nmf_map(\n  population_dep, var = \"densite\", type = \"choro\", nbreaks = 4,\n  pal = \"Dark Mint\",\n  leg_val_rnd = -2,\n  breaks = \"arith\")\n```\n\n```{r}\n# code-fold: true\n# code-summary: Question 2\nmf_map(\n  population_dep, var = \"densite\", type = \"choro\", nbreaks = 4,\n  pal = \"Dark Mint\",\n  leg_val_rnd = -2,\n  breaks = \"quantile\")\n```\n\n```{r}\n# code-fold: true\n# code-summary: Question 3\npopulation_dep_lambert <- population_dep %>% st_transform(2154)\nmf_map(population_dep_lambert)\nmf_map(population_dep_lambert, var = \"densite\", type = \"prop\")\nmf_layout(\n    title = \"Densité en France\"\n)\n```\n\n\n```{r}\n# code-fold: true\n# code-summary: Question 4\nfinistere <- finistere %>% st_transform(2154)\n\nmf_map(\n  finistere,\n  col = \"#CCCCCC\",\n  border = \"white\",\n  lwd = 0.5\n)\nmf_map(\n  finistere, var = \"PTOT\",\n  type = \"prop\",\n  col = \"#c291bc\",\n  border = \"#6b4266\",\n  lwd = 0.5,\n  add = TRUE\n)\nmf_title(\"Population du Finistère\", bg = \"#6b4266\")\nmf_annotation(\n      x = c(132040, 6826675),\n      txt = \"Finistère (29)\",\n      pos = \"bottomleft\",\n      col_txt = \"#6b4266\",\n      cex = 1.2,\n      font = 2,\n      halo = TRUE,\n      s = 1.5\n    )\n```\n\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":true,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../styles.css"],"toc":true,"number-sections":true,"output-file":"cartography.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.8.27","author":"Lino Galiana","theme":"cosmo","code-annotations":"hover","title":"Produire des cartes avec {{< fa brands r-project >}}","bibliography":["../references.bib"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}